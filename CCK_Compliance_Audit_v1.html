<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CCK Compliance Audit</title>
<style>

:root{
      --bg:#f3f4f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --header:#111827; --headerText:#f9fafb; --border:#e5e7eb;
      --line:var(--border);
      --shadow:0 6px 18px rgba(0,0,0,.08); --radius:14px;
      --btn:#111827; --btnText:#f9fafb; --btn2:#ffffff; --btn2Text:#111827;
      --focus:rgba(17,24,39,.15);
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);margin:0;color:var(--text)}
    header{background:var(--header);color:var(--headerText);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;gap:1rem;position:sticky;top:0;z-index:10}
    header h1{font-size:1.05rem;margin:0;letter-spacing:.2px}
    header .env{font-size:.8rem;opacity:.8}
    header .right{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    main{padding:1.25rem;max-width:1240px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1.4fr .6fr;gap:1rem}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem}
    .card h2{margin:.1rem 0 .75rem;font-size:1rem}
    .muted{color:var(--muted)} .mini{font-size:.82rem}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    .tabs{display:flex;gap:.4rem;flex-wrap:wrap}
    .tab{border:1px solid rgba(249,250,251,.25);background:rgba(249,250,251,.08);color:var(--headerText);padding:.45rem .7rem;border-radius:999px;cursor:pointer;font-size:.85rem;user-select:none}
    .tab.active{background:rgba(249,250,251,.22);border-color:rgba(249,250,251,.35)}
    button{border:1px solid var(--border);background:var(--btn);color:var(--btnText);padding:.5rem .75rem;border-radius:10px;cursor:pointer;font-weight:600;font-size:.85rem}
    button.ghost{background:var(--btn2);color:var(--btn2Text)}
    button:focus{outline:3px solid var(--focus);outline-offset:2px}
    button:disabled{opacity:.45;cursor:not-allowed}
    .sm{padding:.35rem .55rem;font-size:.82rem;border-radius:9px}
    input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem;font-size:.9rem;background:#fff;min-height:38px}
    textarea{min-height:84px;width:100%}
    label{font-size:.8rem;color:var(--muted)}
    .field{display:flex;flex-direction:column;gap:.25rem}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:.55rem .5rem;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.78rem;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);text-align:left}
    tr:hover td{background:#fafafa}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .55rem;border-radius:999px;border:1px solid var(--border);background:#fafafa;font-size:.78rem;color:var(--text);white-space:nowrap}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.green{background:#16a34a}.dot.amber{background:#f59e0b}.dot.red{background:#dc2626}.dot.grey{background:#9ca3af}
    .hide{display:none!important}
    .hr{height:1px;background:var(--border);margin:.9rem 0}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem}
    @media (max-width:980px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .box{border:1px solid var(--border);border-radius:12px;padding:.7rem;background:#fff}
    .kpi .big{font-size:1.2rem;font-weight:800}
    .kpi .small{font-size:.78rem;color:var(--muted)}
    .toast{position:fixed;right:18px;bottom:18px;max-width:460px;background:#111827;color:#f9fafb;padding:.75rem .9rem;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.2);display:none;z-index:50}
    .toast.show{display:block}
    .subtle{background:#f9fafb;border:1px dashed var(--border);padding:.75rem;border-radius:12px}
    a{color:#111827}
  
    .cols{
      display:grid;
      grid-template-columns: 2.2fr 1fr;
      gap: 1.25rem;
      align-items:start;
    }
    @media (max-width: 980px){
      .cols{ grid-template-columns: 1fr; }
    }
  

/* Bolt-on pages tweaks */
main{max-width:1200px;margin:0 auto;padding:1.25rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:1rem}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media (max-width: 980px){.grid2{grid-template-columns:1fr}}
.tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:var(--card)}
table{width:100%;border-collapse:collapse}
th,td{padding:.65rem .75rem;border-bottom:1px solid var(--line);vertical-align:top}
th{text-align:left;font-size:.82rem;letter-spacing:.02em;color:var(--muted);background:linear-gradient(to bottom, rgba(17,24,39,.04), rgba(17,24,39,0));position:sticky;top:0}
tr:hover td{background:rgba(17,24,39,.03)}
.pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border:1px solid var(--line);border-radius:999px;font-size:.8rem}
.pill.ok{background:rgba(16,185,129,.10)}
.pill.warn{background:rgba(245,158,11,.12)}
.pill.bad{background:rgba(239,68,68,.10)}
.pill.off{background:rgba(107,114,128,.12)}
.small{font-size:.85rem;color:var(--muted)}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <div class="row" style="gap:.75rem">
    <div style="font-weight:800">Control Operational Compliance Keeper</div>
    <div class="mini muted">Tasks</div>
  </div>

  <div class="row">
    <div id="whoAmI" class="who mini">
      <span class="dot grey"></span>
      <span class="statusText">Not connected</span>
      <span id="whoLabel" style="margin-left:.5rem" class="muted"></span>
    </div>
    <button class="btn" id="loginBtnTop">SNDM Login</button>
    <button class="btn ghost hide" id="logoutBtnTop">Logout</button>
    <button class="btn hide" id="createBtnTop">Create Task</button>
  </div>
</header>
<main>

<section class="card">
  <h2 style="margin:.1rem 0 .6rem 0">Compliance Audit</h2>
  <div class="small">Select a person to see their portfolio. Automation status is shown, but tasks creation stays in the existing tasks board.</div>

  <div class="row" style="margin-top:.9rem; gap:.6rem; flex-wrap:wrap">
    <label style="min-width:260px">
      <div class="mini muted">Person</div>
      <select id="personSel"></select>
    </label>

    <div class="pill" id="autoBadge" style="align-self:end">AUTO: ?</div>

    <button class="btn" id="refreshBtn" style="align-self:end">Refresh</button>
    <button class="btn" id="runOneBtn" style="align-self:end">Run monitor (selected)</button>
    <button class="btn" id="runAllBtn" style="align-self:end">Run monitor (all enabled)</button>
  </div>
</section>

<section class="card" style="margin-top:1rem">
  <h2 style="margin:.1rem 0 .6rem 0">Items</h2>
  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th style="width:110px">Mode</th>
          <th style="width:130px">Last done</th>
          <th style="width:140px">Expiry</th>
          <th style="width:110px">Horizon</th>
          <th style="width:120px">Status</th>
        </tr>
      </thead>
      <tbody id="tblBody"></tbody>
    </table>
  </div>
</section>

</main>

<script>
/** === Supabase config ===
 * Paste your project URL + anon key here (single source of truth).
 */
const SUPABASE_URL  = "https://ungtmfwxqawkdiflmora.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuZ3RtZnd4cWF3a2RpZmxtb3JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDY4NjQsImV4cCI6MjA3NzY4Mjg2NH0.Yaq0XfbbkwxJDUoiPCS7bLVBy70Wa-NOOWIxkpRRxdc";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

function $(q,root=document){ return root.querySelector(q); }
function $all(q,root=document){ return Array.from(root.querySelectorAll(q)); }

function toast(msg, kind="") {
  const el = document.createElement("div");
  el.className = "toast " + (kind||"");
  el.textContent = msg;
  document.body.appendChild(el);
  requestAnimationFrame(()=>el.classList.add("show"));
  setTimeout(()=>{ el.classList.remove("show"); setTimeout(()=>el.remove(), 250); }, 2400);
}

function fmtDate(d) {
  if(!d) return "";
  const dt = (d instanceof Date) ? d : new Date(d);
  if(Number.isNaN(dt.getTime())) return String(d);
  return dt.toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
}

function isoDate(d) {
  if(!d) return null;
  const dt = (d instanceof Date) ? d : new Date(d);
  if(Number.isNaN(dt.getTime())) return null;
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const dd = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}

function addInterval(dateStr, val, unit) {
  // dateStr: YYYY-MM-DD
  if(!dateStr || !val || !unit) return null;
  const dt = new Date(dateStr + "T00:00:00Z");
  if(Number.isNaN(dt.getTime())) return null;
  if(unit==="days") dt.setUTCDate(dt.getUTCDate() + Number(val));
  if(unit==="months") dt.setUTCMonth(dt.getUTCMonth() + Number(val));
  if(unit==="years") dt.setUTCFullYear(dt.getUTCFullYear() + Number(val));
  return isoDate(dt);
}

async function loadStaff() {
  const { data, error } = await sb.schema("cck").from("staff_pool").select("id,display_name").order("display_name");
  if(error) throw error;
  return data || [];
}

async function loadTeams() {
  const { data, error } = await sb.schema("cck").from("teams").select("id,name").order("name");
  if(error) throw error;
  return data || [];
}

async function loadCatalog() {
  const { data, error } = await sb.schema("cck").from("compliance_catalog")
    .select("id,title,cycle_mode,cycle_value,cycle_unit,default_horizon_days,active,category")
    .eq("active", true)
    .order("title");
  if(error) throw error;
  return data || [];
}

async function ensurePersonSettings(staff_id) {
  const { data, error } = await sb.schema("cck").from("compliance_person_settings")
    .select("staff_id,automation_enabled,default_owner_staff_id,default_owner_team_id,default_horizon_days")
    .eq("staff_id", staff_id)
    .maybeSingle();
  if(error) throw error;
  if(data) return data;

  const ins = await sb.schema("cck").from("compliance_person_settings")
    .insert({ staff_id, automation_enabled:false });
  if(ins.error) throw ins.error;

  const again = await sb.schema("cck").from("compliance_person_settings")
    .select("staff_id,automation_enabled,default_owner_staff_id,default_owner_team_id,default_horizon_days")
    .eq("staff_id", staff_id)
    .maybeSingle();
  if(again.error) throw again.error;
  return again.data;
}

async function loadAssignments(staff_id) {
  // Pull assignments + record dates using the audit view
  const { data, error } = await sb.schema("cck").from("v_compliance_audit")
    .select("catalog_id,compliance_title,category,cycle_mode,cycle_value,cycle_unit,horizon_days,manual_next_expiry_at,last_completed_at,next_expiry_at,automation_enabled")
    .eq("staff_id", staff_id)
    .order("compliance_title");
  if(error) throw error;
  return data || [];
}

async function upsertAssignment(staff_id, catalog_id, active=true) {
  // Insert if missing; set active accordingly.
  const { data: existing, error: selErr } = await sb.schema("cck").from("compliance_assignments")
    .select("id,active").eq("staff_id", staff_id).eq("catalog_id", catalog_id).maybeSingle();
  if(selErr) throw selErr;
  if(!existing) {
    const ins = await sb.schema("cck").from("compliance_assignments").insert({ staff_id, catalog_id, active });
    if(ins.error) throw ins.error;
  } else {
    const upd = await sb.schema("cck").from("compliance_assignments").update({ active }).eq("id", existing.id);
    if(upd.error) throw upd.error;
  }
}

async function deleteAssignment(staff_id, catalog_id) {
  // Soft-off: set active false to preserve history.
  const upd = await sb.schema("cck").from("compliance_assignments").update({ active:false })
    .eq("staff_id", staff_id).eq("catalog_id", catalog_id);
  if(upd.error) throw upd.error;
}

async function upsertRecord(staff_id, catalog_id, last_completed_at=null, next_expiry_at=null, last_task_id=null) {
  const payload = { staff_id, catalog_id, last_completed_at, next_expiry_at, last_task_id };
  const res = await sb.schema("cck").from("compliance_records").upsert(payload, { onConflict:"staff_id,catalog_id" });
  if(res.error) throw res.error;
}

async function setManualExpiry(staff_id, catalog_id, manual_next_expiry_at=null) {
  const res = await sb.schema("cck").from("compliance_assignments")
    .update({ manual_next_expiry_at })
    .eq("staff_id", staff_id).eq("catalog_id", catalog_id);
  if(res.error) throw res.error;
}

async function setOverrides(staff_id, catalog_id, horizon_override_days=null, cycle_override_value=null, cycle_override_unit=null) {
  const res = await sb.schema("cck").from("compliance_assignments")
    .update({ horizon_override_days, cycle_override_value, cycle_override_unit })
    .eq("staff_id", staff_id).eq("catalog_id", catalog_id);
  if(res.error) throw res.error;
}

async function updatePersonSettings(staff_id, patch) {
  const res = await sb.schema("cck").from("compliance_person_settings").update(patch).eq("staff_id", staff_id);
  if(res.error) throw res.error;
}

function statusPill(row) {
  const mode = row.cycle_mode;
  if(mode==="tbc") return `<span class="pill off">TBC</span>`;
  if(mode==="manual" && !row.manual_next_expiry_at && !row.next_expiry_at) return `<span class="pill off">Manual</span>`;
  if(mode==="one_time") {
    return row.last_completed_at ? `<span class="pill ok">Done</span>` : `<span class="pill warn">Not done</span>`;
  }
  const exp = row.manual_next_expiry_at || row.next_expiry_at;
  if(!exp) return `<span class="pill off">No date</span>`;
  const expDt = new Date(exp + "T00:00:00Z");
  const now = new Date();
  const horizonDays = Number(row.horizon_days || 60);
  const horizonStart = new Date(expDt.getTime());
  horizonStart.setUTCDate(horizonStart.getUTCDate() - horizonDays);

  if(now > expDt) return `<span class="pill bad">Overdue</span>`;
  if(now >= horizonStart) return `<span class="pill warn">Due soon</span>`;
  return `<span class="pill ok">OK</span>`;
}


let STAFF=[], TEAMS=[];
let currentStaffId=null;

function nameForStaffId(id){
  const s = STAFF.find(x=>x.id===id);
  return s ? s.display_name : "";
}

async function boot(){
  try{
    STAFF = await loadStaff();
    const sel = $("#personSel");
    if(!sel){
      console.error("Audit page miswired: #personSel not found");
      toast("Audit page miswired: person selector missing (#personSel).","bad");
      return;
    }
    sel.innerHTML = "";
    opt(sel,"","Select person...");
    STAFF.forEach(s=>opt(sel, s.id, s.display_name));
    sel.addEventListener("change", async ()=>{
      currentStaffId = sel.value || null;
      await loadAudit();
    });
    $("#refreshBtn").addEventListener("click", loadAudit);
    $("#runOneBtn").addEventListener("click", async ()=>{ if(currentStaffId) await runMonitorFor([currentStaffId]); else toast("Pick a person","bad"); });
    $("#runAllBtn").addEventListener("click", async ()=>{ await runMonitorAllEnabled(); });

    $("#tblBody").innerHTML = `<tr><td colspan="6" class="muted">Select a person.</td></tr>`;
  }catch(e){
    console.error(e);
    toast(e.message || "Failed to boot","bad");
  }
}

async function loadAudit(){
  if(!currentStaffId){
    $("#tblBody").innerHTML = `<tr><td colspan="6" class="muted">Select a person.</td></tr>`;
    $("#autoBadge").textContent = "AUTO: ?";
    $("#autoBadge").className = "pill";
    return;
  }
  try{
    const rows = await loadAssignments(currentStaffId);
    const auto = rows.length ? rows[0].automation_enabled : (await ensurePersonSettings(currentStaffId)).automation_enabled;
    $("#autoBadge").textContent = "AUTO: " + (auto ? "ON" : "OFF");
    $("#autoBadge").className = "pill " + (auto ? "ok" : "off");

    const tb = $("#tblBody");
    tb.innerHTML = rows.map(r=>{
      const exp = r.manual_next_expiry_at || r.next_expiry_at || "";
      return `
        <tr>
          <td><div style="font-weight:700">${r.compliance_title}</div><div class="small">${r.category||""}</div></td>
          <td><span class="pill">${r.cycle_mode}</span></td>
          <td>${fmtDate(r.last_completed_at)}</td>
          <td>${fmtDate(exp)}</td>
          <td>${r.horizon_days ?? 60}</td>
          <td>${statusPill(r)}</td>
        </tr>
      `;
    }).join("") || `<tr><td colspan="6" class="muted">No assigned items yet.</td></tr>`;
  }catch(e){
    console.error(e);
    toast(e.message || "Failed to load audit","bad");
  }
}

async function getEnabledStaffIds(){
  const { data, error } = await sb.schema("cck").from("compliance_person_settings").select("staff_id").eq("automation_enabled", true);
  if(error) throw error;
  return (data||[]).map(x=>x.staff_id);
}

async function effectiveRouting(staff_id, catalogRow){
  const ps = await ensurePersonSettings(staff_id);

  const owner_staff_id = ps.default_owner_staff_id || catalogRow.default_owner_staff_id || null;
  const owner_team_id  = ps.default_owner_team_id  || catalogRow.default_owner_team_id  || null;
  const horizon_days   = ps.default_horizon_days ?? null;
  return { owner_staff_id, owner_team_id, horizon_days };
}

async function runMonitorAllEnabled(){
  const ids = await getEnabledStaffIds();
  if(!ids.length){ toast("No enabled people","warn"); return; }
  await runMonitorFor(ids);
}

async function runMonitorFor(staff_ids){
  try{
    // Pull audit rows for these staff from view
    const or = staff_ids.map(id=>`staff_id.eq.${id}`).join(",");
    const { data: rows, error } = await sb.schema("cck").from("v_compliance_audit")
      .select("staff_id,display_name,catalog_id,compliance_title,category,cycle_mode,cycle_value,cycle_unit,horizon_days,manual_next_expiry_at,last_completed_at,next_expiry_at,automation_enabled")
      .or(or);
    if(error) throw error;

    // Need catalog defaults for routing
    const { data: catalog, error: cErr } = await sb.schema("cck").from("compliance_catalog")
      .select("id,title,default_owner_staff_id,default_owner_team_id,default_horizon_days,cycle_mode,cycle_value,cycle_unit")
      .eq("active", true);
    if(cErr) throw cErr;
    const catById = new Map((catalog||[]).map(c=>[c.id,c]));

    let created = 0;

    for(const r of (rows||[])){
      if(!r.automation_enabled) continue;

      const c = catById.get(r.catalog_id);
      if(!c) continue;

      // Determine "is due / should generate?"
      if(r.cycle_mode === "tbc") continue;

      if(r.cycle_mode === "one_time"){
        if(r.last_completed_at) continue; // already done
        // generate immediately (expiry not applicable)
      }

      // Determine expiry date
      let expiry = r.manual_next_expiry_at || r.next_expiry_at || null;

      // For fixed cycles, if we have last_completed but next_expiry missing, compute
      if(r.cycle_mode==="fixed" && r.last_completed_at && !expiry){
        expiry = addInterval(r.last_completed_at, r.cycle_value, r.cycle_unit);
        // persist
        await upsertRecord(r.staff_id, r.catalog_id, r.last_completed_at, expiry, null);
      }

      // For manual, require explicit expiry to generate based on horizon (otherwise leave for admin)
      if(r.cycle_mode==="manual" && !expiry) continue;

      // Determine effective horizon
      const horizonDays = Number(r.horizon_days ?? 60);
      const now = new Date();
      let inHorizon = true;

      if(expiry){
        const expDt = new Date(expiry + "T00:00:00Z");
        const horizonStart = new Date(expDt.getTime());
        horizonStart.setUTCDate(horizonStart.getUTCDate() - horizonDays);
        inHorizon = now >= horizonStart;
      }

      // For one_time with no expiry, treat as inHorizon
      if(r.cycle_mode==="one_time") inHorizon = true;

      if(!inHorizon) continue;

      // Dedupe: check map for open task for this staff+catalog+cycle_expiry_at
      const cycle_expiry_at = expiry || null;

      const { data: existingMap, error: mErr } = await sb.schema("cck").from("compliance_task_map")
        .select("id,task_id,status")
        .eq("staff_id", r.staff_id)
        .eq("catalog_id", r.catalog_id)
        .eq("cycle_expiry_at", cycle_expiry_at)
        .eq("status", "open")
        .limit(1);
      if(mErr) throw mErr;
      if(existingMap && existingMap.length) continue;

      // Create task in existing tasks table
      const route = await effectiveRouting(r.staff_id, c);

      const title = c.title; // exactly the compliance title
      const expiryTxt = expiry ? fmtDate(expiry) : "N/A";
      const desc = `Compliance item is approaching expiry.\n\nCurrent expiry date: ${expiryTxt}\nCycle: ${c.cycle_mode==="fixed" ? `${c.cycle_value} ${c.cycle_unit}` : c.cycle_mode}\nTriggered within ${horizonDays} day horizon.\n\nCompletion of this task will reset the compliance cycle.`;

      const taskPayload = {
        title,
        description: desc,
        task_type: "compliance",
        due_at: expiry ? (expiry + "T09:00:00Z") : null,
        target_staff_id: r.staff_id,
        owner_staff_id: route.owner_staff_id,
        target_team_id: route.owner_team_id
      };

      const insTask = await sb.schema("cck").from("tasks").insert(taskPayload).select("id").single();
      if(insTask.error) throw insTask.error;

      const task_id = insTask.data.id;

      const insMap = await sb.schema("cck").from("compliance_task_map").insert({
        task_id,
        staff_id: r.staff_id,
        catalog_id: r.catalog_id,
        cycle_expiry_at,
        status: "open"
      });
      if(insMap.error) throw insMap.error;

      created++;
    }

    toast(`Monitor run complete. Created ${created} task(s).`, created ? "ok" : "warn");
    await loadAudit();
  }catch(e){
    console.error(e);
    toast(e.message || "Monitor failed","bad");
  }
}

function opt(el, value, label){
  const o=document.createElement("option");
  o.value=value; o.textContent=label;
  el.appendChild(o);
}

window.addEventListener("DOMContentLoaded", ()=> boot());

</script>
</body>
</html>

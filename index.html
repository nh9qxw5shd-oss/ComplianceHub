<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Control Operational Compliance Keeper - Tasks</title>
  <style>
:root{
      --bg:#f3f4f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --header:#111827; --headerText:#f9fafb; --border:#e5e7eb;
      --shadow:0 6px 18px rgba(0,0,0,.08); --radius:14px;
      --btn:#111827; --btnText:#f9fafb; --btn2:#ffffff; --btn2Text:#111827;
      --focus:rgba(17,24,39,.15);
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);margin:0;color:var(--text)}
    header{background:var(--header);color:var(--headerText);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;gap:1rem;position:sticky;top:0;z-index:10}
    header h1{font-size:1.05rem;margin:0;letter-spacing:.2px}
    header .env{font-size:.8rem;opacity:.8}
    header .right{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    main{padding:1.25rem;max-width:1240px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1.4fr .6fr;gap:1rem}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem}
    .card h2{margin:.1rem 0 .75rem;font-size:1rem}
    .muted{color:var(--muted)} .mini{font-size:.82rem}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    .tabs{display:flex;gap:.4rem;flex-wrap:wrap}
    .tab{border:1px solid rgba(249,250,251,.25);background:rgba(249,250,251,.08);color:var(--headerText);padding:.45rem .7rem;border-radius:999px;cursor:pointer;font-size:.85rem;user-select:none}
    .tab.active{background:rgba(249,250,251,.22);border-color:rgba(249,250,251,.35)}
    button{border:1px solid var(--border);background:var(--btn);color:var(--btnText);padding:.5rem .75rem;border-radius:10px;cursor:pointer;font-weight:600;font-size:.85rem}
    button.ghost{background:var(--btn2);color:var(--btn2Text)}
    button:focus{outline:3px solid var(--focus);outline-offset:2px}
    button:disabled{opacity:.45;cursor:not-allowed}
    .sm{padding:.35rem .55rem;font-size:.82rem;border-radius:9px}
    input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem;font-size:.9rem;background:#fff;min-height:38px}
    textarea{min-height:84px;width:100%}
    label{font-size:.8rem;color:var(--muted)}
    .field{display:flex;flex-direction:column;gap:.25rem}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:.55rem .5rem;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.78rem;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);text-align:left}
    tr:hover td{background:#fafafa}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .55rem;border-radius:999px;border:1px solid var(--border);background:#fafafa;font-size:.78rem;color:var(--text);white-space:nowrap}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.green{background:#16a34a}.dot.amber{background:#f59e0b}.dot.red{background:#dc2626}.dot.grey{background:#9ca3af}
    .hide{display:none!important}
    .hr{height:1px;background:var(--border);margin:.9rem 0}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem}
    @media (max-width:980px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .box{border:1px solid var(--border);border-radius:12px;padding:.7rem;background:#fff}
    .kpi .big{font-size:1.2rem;font-weight:800}
    .kpi .small{font-size:.78rem;color:var(--muted)}
    .toast{position:fixed;right:18px;bottom:18px;max-width:460px;background:#111827;color:#f9fafb;padding:.75rem .9rem;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.2);display:none;z-index:50}
    .toast.show{display:block}
    .subtle{background:#f9fafb;border:1px dashed var(--border);padding:.75rem;border-radius:12px}
    a{color:#111827}
  
    .cols{
      display:grid;
      grid-template-columns: 2.2fr 1fr;
      gap: 1.25rem;
      align-items:start;
    }
    @media (max-width: 980px){
      .cols{ grid-template-columns: 1fr; }
    }
    /* Fix ghost buttons when used as links in header */
header a.btn.ghost {
  color: #e5e7eb;              /* light grey text */
  border: 1px solid #374151;   /* subtle outline */
  background: transparent;
  text-decoration: none;
}

header a.btn.ghost:hover {
  background: rgba(255,255,255,0.08);
}
  
    /* Progress bar */
    .progressOuter{width:100%;height:12px;border-radius:999px;background:#e5e7eb;overflow:hidden;border:1px solid #d1d5db}
    .progressInner{height:100%;width:0%;background:#111827}

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <div class="row" style="gap:.75rem">
    <div style="font-weight:800">Control Operational Compliance Keeper</div>
    <div class="mini muted">Tasks</div>
  </div>

  <div class="row">
  <div id="whoAmI" class="who mini">
    <span class="dot grey"></span>
    <span class="statusText">Not connected</span>
    <span id="whoLabel" style="margin-left:.5rem" class="muted"></span>
  </div>

  <a href="CCK_Compliance_Audit_v1.html" class="btn ghost sm hide" id="auditLink">
    Compliance Audit
  </a>

  <a href="CCK_Compliance_Admin_v1.html" class="btn ghost sm hide" id="adminLink">
    Compliance Admin
  </a>

  <button class="btn" id="loginBtnTop">SNDM Login</button>
  <button class="btn ghost hide" id="logoutBtnTop">Logout</button>
  <button class="btn hide" id="createBtnTop">Create Task</button>
</div>
</header>

<main>
  <div class="cols">
    <section class="card" id="tasksCard">
      <div class="row space">
        <h2 style="margin:0">Tasks</h2>
        <button class="ghost" id="refreshBtn">Refresh</button>
      </div>

      <div class="row" style="flex-wrap:wrap;gap:.75rem;margin-top:.6rem">
        <div class="field" style="min-width:210px;flex:1">
          <label>Filter: Team</label>
          <select id="filterTeam"><option value="">All</option></select>
        </div>
        <div class="field" style="min-width:210px;flex:1">
          <label>Filter: Staff</label>
          <select id="filterStaff"><option value="">All</option></select>
        </div>
        <div class="field" style="min-width:160px">
          <label>Status</label>
          <select id="filterStatus">
            <option value="">All</option>
            <option value="open">Open</option>
            <option value="complete">Complete</option>
          </select>
        </div>
        <div class="field" style="min-width:220px;flex:1">
          <label>Search</label>
          <input id="searchBox" placeholder="Title or description"/>
        </div>
      </div>

      <div class="row" style="gap:.6rem;flex-wrap:wrap;margin-top:.6rem">
        <span class="pill"><span class="dot red"></span><span class="mini">Overdue</span> <b id="kpiRed">0</b></span>
        <span class="pill"><span class="dot amber"></span><span class="mini">Due soon</span> <b id="kpiAmber">0</b></span>
        <span class="pill"><span class="dot green"></span><span class="mini">OK</span> <b id="kpiGreen">0</b></span>
        <span class="pill"><span class="dot grey"></span><span class="mini">Open</span> <b id="kpiDue">0</b></span>
      </div>


      <div id="progressWrap" class="subtle" style="margin-top:.6rem">
        <div class="row space" style="align-items:center">
          <div class="mini muted">Progress</div>
          <div class="mini"><b id="progPct">0%</b></div>
        </div>
        <div class="progressOuter" aria-label="Progress bar">
          <div id="progBar" class="progressInner" style="width:0%"></div>
        </div>
        <div class="mini muted" id="progSub" style="margin-top:.35rem">Loading…</div>
      </div>

      <div class="hr"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:84px">RAG</th>
              <th>Task</th>
              <th style="width:120px">Due</th>
              <th style="width:200px">Target</th>
              <th style="width:160px">Owner</th>
              <th style="width:200px">Actions</th>
            </tr>
          </thead>
          <tbody id="taskTbody"></tbody>
        </table>
      </div>
    </section>

    <aside class="card" id="actionsCard">
      <div class="row space">
        <div style="font-weight:850" id="detailTitle">Controller</div>
        <span class="mini muted" id="detailSub"></span>
      </div>

      <div id="controllerCard" style="margin-top:.6rem">
        <div class="mini muted">Pick your name to complete tasks without logging in.</div>
        <div class="row" style="gap:.6rem;flex-wrap:wrap;margin-top:.5rem">
          <div class="field" style="flex:1;min-width:220px">
            <label>Controller</label>
            <select id="controllerStaff"><option value="">Select…</option></select>
          </div>
          <button class="btn" id="enterController">Set</button>
          <button class="btn ghost" id="exitController">Clear</button>
        </div>
      </div>

      <div id="authCard" class="hide" style="margin-top:.8rem">
        <div class="mini muted">SNDM login (create tasks, undo completions). Notes can be added by anyone.</div>
        <div class="row" style="gap:.6rem;flex-wrap:wrap;margin-top:.5rem">
          <div class="field" style="flex:1;min-width:220px">
            <label>Email</label>
            <input id="email" type="email" autocomplete="username"/>
          </div>
          <div class="field" style="flex:1;min-width:220px">
            <label>Password</label>
            <input id="pass" type="password" autocomplete="current-password"/>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:.5rem;gap:.5rem">
          <button class="ghost" id="authCancel">Cancel</button>
          <button class="btn" id="doLogin">Login</button>
        </div>
      </div>

      <div class="hr"></div>

      <div id="detailBody" class="mini muted">Select a task to view notes and actions.</div>
    </aside>
  </div>
</main>

<div id="createModal" class="hide" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:60;padding:16px">
  <div class="card" style="max-width:860px;width:100%">
    <div class="row space" style="align-items:flex-start">
      <div>
        <div style="font-weight:850;font-size:1rem">Create task</div>
        <div class="mini muted">SNDM only</div>
      </div>
      <button class="ghost" id="c_cancel">Close</button>
    </div>

    <div class="hr"></div>

    <div class="row" style="gap:.8rem;flex-wrap:wrap;align-items:flex-end">
      <div class="field" style="min-width:220px">
        <label>Task type</label>
        <select id="c_type">
          <option value="adhoc">Ad-hoc</option>
          <option value="dated">Dated</option>
          <option value="quarterly">Quarterly</option>
        </select>
      </div>

      <div class="field hide" style="min-width:240px" id="dueWrap">
        <label>Due date</label>
        <input id="ct_due" type="date"/>
      </div>

      <div class="field hide" style="min-width:220px" id="qWrap">
        <label>Quarter</label>
        <input id="ct_quarter" placeholder="e.g. 2026 Q1"/>
      </div>
    </div>

    <div class="row" style="gap:.8rem;flex-wrap:wrap;margin-top:.6rem">
      <div class="field" style="flex:1;min-width:260px">
        <label>Title</label>
        <input id="c_title" placeholder="Title"/>
      </div>
    </div>

    <div class="field" style="margin-top:.6rem">
      <label>Description</label>
      <textarea id="c_desc" placeholder="What is this, in plain English"></textarea>
    </div>

    <div class="row" style="gap:.8rem;flex-wrap:wrap;margin-top:.6rem">
      <div class="field" style="min-width:220px;flex:1">
        <label>Target Team</label>
        <select id="ct_targetTeam"><option value="">None</option></select>
      </div>
      <div class="field" style="min-width:220px;flex:1">
        <label>Target Staff</label>
        <select id="ct_targetStaff"><option value="">None</option></select>
      </div>
      <div class="field" style="min-width:220px;flex:1">
        <label>Owner</label>
        <select id="ct_owner"><option value="">None</option></select>
      </div>
    </div>

    <div class="hr"></div>
    <div class="row" style="justify-content:flex-end;gap:.5rem">
      <button class="ghost" id="c_cancel2">Cancel</button>
      <button class="btn" id="c_create">Create</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  // ========= BAKED SUPABASE CONFIG (edit here only) =========
  window.SUPABASE_URL = "https://ungtmfwxqawkdiflmora.supabase.co";
  window.SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuZ3RtZnd4cWF3a2RpZmxtb3JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDY4NjQsImV4cCI6MjA3NzY4Mjg2NH0.Yaq0XfbbkwxJDUoiPCS7bLVBy70Wa-NOOWIxkpRRxdc";

  const $ = (q)=>document.querySelector(q);
  const toast = (msg)=>{
    const t=$("#toast"); if(!t) return alert(msg);
    t.textContent=msg; t.classList.add("show");
    clearTimeout(toast._t); toast._t=setTimeout(()=>t.classList.remove("show"), 2600);
  };
  const escapeHtml = (s)=>String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
  const fmtDate = (iso)=>{
    if(!iso) return "";
    const d=new Date(iso);
    if(isNaN(d)) return "";
    return d.toISOString().slice(0,10);
  };
  const quarterToDate = (q)=>{
    const m = String(q||"").match(/(\d{4})\s*Q([1-4])/i);
    if(!m) return null;
    const y=Number(m[1]), qq=Number(m[2]);
    const endMonth = qq*3;
    return new Date(Date.UTC(y, endMonth, 0, 23,59,59));
  };
  const rag = (task, complete)=>{
    if(complete) return "green";
    const now = new Date();
    const due = (task.task_type==="quarterly" && task.quarter) ? quarterToDate(task.quarter)
              : (task.due_at ? new Date(task.due_at) : null);
    if(!due || isNaN(due)) return "amber";
    const diffDays = Math.floor((due - now)/86400000);
    if(diffDays < 0) return "red";
    if(diffDays <= 3) return "amber";
    return "green";
  };

  let sb = null;
  const me = { mode: "controller", user_id: null, role: null, display_name: null, staff_id: null };
  const cache = { teams: [], staff: [], tasks: [], notesByTask: new Map(), compByTask: new Map() };
  let selectedTaskId = null;

  function canConnect(){
    return (typeof window.SUPABASE_URL === "string" && window.SUPABASE_URL.length > 10) &&
           (typeof window.SUPABASE_ANON === "string" && window.SUPABASE_ANON.length > 20) &&
           !window.SUPABASE_ANON.includes("YOUR_REAL_ANON");
  }
  function setConn(ok){
    const dot = document.querySelector("header .dot");
    const text = document.querySelector("header .statusText");
    if(dot) dot.className = "dot " + (ok ? "green" : "grey");
    if(text) text.textContent = ok ? "Connected" : "Not connected";
  }
  function initSupabase(){
    if(!canConnect()){ setConn(false); toast("Supabase anon key not set (edit window.SUPABASE_ANON in the HTML)."); return null; }
    if(!window.supabase || !window.supabase.createClient){ setConn(false); toast("Supabase JS failed to load"); return null; }
    sb = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON, {
      auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
    });
    return sb;
  }

  // ===== Compliance monitor (hybrid run on tasks page load) =====
const COMPLIANCE_MONITOR_THROTTLE_MINUTES = 15;
const COMPLIANCE_MONITOR_KEY = "cck_lastComplianceMonitorRun";

function shouldRunComplianceMonitor(){
  try{
    const last = Number(localStorage.getItem(COMPLIANCE_MONITOR_KEY) || "0");
    const now = Date.now();
    return (now - last) > (COMPLIANCE_MONITOR_THROTTLE_MINUTES * 60 * 1000);
  }catch(e){
    return true;
  }
}
function markComplianceMonitorRan(){
  try{ localStorage.setItem(COMPLIANCE_MONITOR_KEY, String(Date.now())); }catch(e){}
}

function isoDate(d){
  if(!d) return null;
  const dt = (d instanceof Date) ? d : new Date(d);
  if(Number.isNaN(dt.getTime())) return null;
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const dd = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function addInterval(dateStr, val, unit){
  if(!dateStr || !val || !unit) return null;
  const dt = new Date(dateStr + "T00:00:00Z");
  if(Number.isNaN(dt.getTime())) return null;
  if(unit==="days") dt.setUTCDate(dt.getUTCDate() + Number(val));
  if(unit==="months") dt.setUTCMonth(dt.getUTCMonth() + Number(val));
  if(unit==="years") dt.setUTCFullYear(dt.getUTCFullYear() + Number(val));
  return isoDate(dt);
}

async function runComplianceMonitorAllEnabled(){
  if(!sb) return;
  if(!shouldRunComplianceMonitor()) return;

  // Mark early to avoid rapid refresh loops spamming
  markComplianceMonitorRan();

  // Who is enabled?
  const enabledRes = await sb.schema("cck").from("compliance_person_settings")
    .select("staff_id,default_owner_staff_id,default_owner_team_id,default_horizon_days")
    .eq("automation_enabled", true);

  if(enabledRes.error) throw enabledRes.error;
  const enabled = enabledRes.data || [];
  if(!enabled.length) return;

  const staffIds = enabled.map(x=>x.staff_id);

  // Pull audit rows for enabled staff
  const or = staffIds.map(id=>`staff_id.eq.${id}`).join(",");
  const auditRes = await sb.schema("cck").from("v_compliance_audit")
    .select("staff_id,catalog_id,compliance_title,cycle_mode,cycle_value,cycle_unit,horizon_days,manual_next_expiry_at,last_completed_at,next_expiry_at,automation_enabled")
    .or(or);

  if(auditRes.error) throw auditRes.error;
  const rows = auditRes.data || [];

  // Pull catalog (for defaults + title)
  const catRes = await sb.schema("cck").from("compliance_catalog")
    .select("id,title,cycle_mode,cycle_value,cycle_unit,default_owner_staff_id,default_owner_team_id,default_horizon_days,active")
    .eq("active", true);

  if(catRes.error) throw catRes.error;
  const catById = new Map((catRes.data||[]).map(c=>[c.id,c]));

  // Person settings lookup
  const psByStaff = new Map(enabled.map(p=>[p.staff_id,p]));

  const now = new Date();

  for(const r of rows){
    if(!r.automation_enabled) continue;

    const c = catById.get(r.catalog_id);
    if(!c) continue;

    // ignore TBC
    if(r.cycle_mode === "tbc") continue;

    // one-time: only if never completed
    if(r.cycle_mode === "one_time" && r.last_completed_at) continue;

    let expiry = r.manual_next_expiry_at || r.next_expiry_at || null;

    // compute fixed expiry if missing but we have last completed
    if(r.cycle_mode==="fixed" && r.last_completed_at && !expiry){
      expiry = addInterval(r.last_completed_at, r.cycle_value, r.cycle_unit);
      // persist for consistency
      const up = await sb.schema("cck").from("compliance_records").upsert(
        { staff_id:r.staff_id, catalog_id:r.catalog_id, last_completed_at:r.last_completed_at, next_expiry_at:expiry, last_task_id:null },
        { onConflict:"staff_id,catalog_id" }
      );
      if(up.error) throw up.error;
    }

    // manual must have explicit expiry to trigger
    if(r.cycle_mode==="manual" && !expiry) continue;

    const horizonDays = Number(r.horizon_days ?? 60);

    let inHorizon = true;
    if(expiry){
      const expDt = new Date(expiry + "T00:00:00Z");
      const horizonStart = new Date(expDt.getTime());
      horizonStart.setUTCDate(horizonStart.getUTCDate() - horizonDays);
      inHorizon = now >= horizonStart;
      if(now > expDt) inHorizon = true; // overdue is definitely in scope
    }
    if(r.cycle_mode==="one_time") inHorizon = true;

    if(!inHorizon) continue;

    // Check map for open entry (avoid dupes). NOTE: null expiry needs `.is()` not `.eq()`.
    const cycle_expiry_at = expiry || null;
    let mapQ = sb.schema("cck").from("compliance_task_map")
      .select("id")
      .eq("staff_id", r.staff_id)
      .eq("catalog_id", r.catalog_id)
      .eq("status", "open");
    mapQ = (cycle_expiry_at === null) ? mapQ.is("cycle_expiry_at", null) : mapQ.eq("cycle_expiry_at", cycle_expiry_at);
    const mapRes = await mapQ.limit(1);

    if(mapRes.error) throw mapRes.error;
    if((mapRes.data||[]).length) continue;

    const ps = psByStaff.get(r.staff_id) || {};
    const owner_staff_id = ps.default_owner_staff_id || c.default_owner_staff_id || null;
    const target_team_id  = ps.default_owner_team_id  || c.default_owner_team_id  || null;

    const expiryTxt = expiry ? expiry : "N/A";
    const desc =
`Compliance item is approaching expiry.

Expiry date: ${expiryTxt}`;

    // Create normal task (your core table)
    const insTask = await sb.schema("cck").from("tasks")
      .insert({
        title: c.title,                 // ✅ title matches compliance title
        description: desc,              // ✅ expiry in description
        task_type: "compliance",
        due_at: expiry ? new Date(expiry + "T09:00:00Z").toISOString() : null,
        quarter: null,
        target_team_id,
        target_staff_id: r.staff_id,
        owner_staff_id
      })
      .select("id").single();

    if(insTask.error) throw insTask.error;

    // Map it (dedupe anchor)
    const insMap = await sb.schema("cck").from("compliance_task_map")
      .insert({
        task_id: insTask.data.id,
        staff_id: r.staff_id,
        catalog_id: r.catalog_id,
        cycle_expiry_at,
        status: "open"
      });

    // Ignore unique race (another browser created it same time)
    if(insMap.error && insMap.error.code !== "23505") throw insMap.error;
  }
}

  async function loadReference(){
    const [teamsRes, staffRes] = await Promise.all([
      sb.schema("cck").from("teams").select("id,name").order("name"),
      sb.schema("cck").from("staff_pool").select("id,display_name").order("display_name")
    ]);
    if(teamsRes.error) throw teamsRes.error;
    if(staffRes.error) throw staffRes.error;
    cache.teams = teamsRes.data || [];
    cache.staff = staffRes.data || [];
  }

  async function loadTasks(){
    const res = await sb.schema("cck").from("tasks")
      .select("id,title,description,task_type,due_at,quarter,target_team_id,target_staff_id,owner_staff_id,created_at")
      .order("created_at", { ascending:false });
    if(res.error) throw res.error;
    cache.tasks = res.data || [];

    const ids = cache.tasks.map(t=>t.id);
    cache.notesByTask = new Map();
    cache.compByTask = new Map();

    if(ids.length){
      const [notesRes, compRes] = await Promise.all([
        sb.schema("cck").from("task_notes")
          .select("id,task_id,note,author_user_id,created_at")
          .in("task_id", ids).order("created_at", { ascending:false }),
        sb.schema("cck").from("task_completions")
          .select("task_id,completed,completed_at,completed_by_user_id")
          .or(ids.map(id=>`task_id.eq.${id}`).join(","))
      ]);
      if(notesRes.error) throw notesRes.error;
      if(compRes.error) throw compRes.error;

      (notesRes.data||[]).forEach(n=>{
        const arr = cache.notesByTask.get(n.task_id) || [];
        arr.push(n);
        cache.notesByTask.set(n.task_id, arr);
      });
      (compRes.data||[]).forEach(c=>cache.compByTask.set(c.task_id, c));
    }
  }

  function nameForTeam(id){ return (cache.teams.find(t=>t.id===id)?.name)||""; }
  function nameForStaff(id){ return (cache.staff.find(s=>s.id===id)?.display_name)||""; }
  function isTaskComplete(task_id){ return !!(cache.compByTask.get(task_id)?.completed); }

  function renderFilters(){
    $("#filterTeam").innerHTML = `<option value="">All</option>` + cache.teams.map(t=>`<option value="${t.id}">${escapeHtml(t.name)}</option>`).join("");
    $("#filterStaff").innerHTML = `<option value="">All</option>` + cache.staff.map(s=>`<option value="${s.id}">${escapeHtml(s.display_name)}</option>`).join("");
    $("#controllerStaff").innerHTML = `<option value="">Select…</option>` + cache.staff.map(s=>`<option value="${s.id}">${escapeHtml(s.display_name)}</option>`).join("");

    $("#ct_targetTeam").innerHTML = `<option value="">None</option>` + cache.teams.map(t=>`<option value="${t.id}">${escapeHtml(t.name)}</option>`).join("");
    $("#ct_targetStaff").innerHTML = `<option value="">None</option>` + cache.staff.map(s=>`<option value="${s.id}">${escapeHtml(s.display_name)}</option>`).join("");
    $("#ct_owner").innerHTML = `<option value="">None</option>` + cache.staff.map(s=>`<option value="${s.id}">${escapeHtml(s.display_name)}</option>`).join("");

  }

  function renderTaskKpis(rows){
    const open = rows.filter(r=>!r.complete);
    $("#kpiDue").textContent = open.length;
    $("#kpiRed").textContent = open.filter(r=>r.rag==="red").length;
    $("#kpiAmber").textContent = open.filter(r=>r.rag==="amber").length;
    $("#kpiGreen").textContent = open.filter(r=>r.rag==="green").length;
  }
  // ===== Progress (Tasks + Compliance portfolios) =====
  let _progressReq = 0;

  function setProgress(pct, sub){
    const pctEl = $("#progPct");
    const barEl = $("#progBar");
    const subEl = $("#progSub");
    if(pctEl) pctEl.textContent = `${pct}%`;
    if(barEl) barEl.style.width = `${pct}%`;
    if(subEl) subEl.textContent = sub || "";
  }

  async function computePortfolioProgress(staffId){
    // Portfolio progress = "currently compliant" items / total assigned items
    // - one_time: compliant if last_completed_at exists
    // - fixed/manual: compliant if expiry exists and today <= expiry
    // - tbc/missing dates: not compliant
    let q = sb.schema("cck").from("v_compliance_audit")
      .select("staff_id,cycle_mode,last_completed_at,next_expiry_at,manual_next_expiry_at");

    if(staffId) q = q.eq("staff_id", staffId);

    const res = await q;
    if(res.error) throw res.error;

    const rows = res.data || [];
    const now = new Date();
    let total = 0, compliant = 0;

    for(const r of rows){
      total += 1;
      const mode = (r.cycle_mode || "").toLowerCase();

      if(mode === "one_time"){
        if(r.last_completed_at) compliant += 1;
        continue;
      }
      if(mode === "tbc"){
        continue;
      }
      const exp = r.manual_next_expiry_at || r.next_expiry_at;
      if(!exp) continue;

      const expDt = new Date(exp + "T00:00:00Z");
      if(!isNaN(expDt) && now <= expDt) compliant += 1;
    }

    return { total, compliant };
  }

  async function updateProgress(rows){
    const req = ++_progressReq;

    // Manual tasks: exclude compliance auto-generated tasks to avoid double counting portfolio.
    const manual = rows.filter(r => (r.t.task_type || "").toLowerCase() !== "compliance");
    const manualTotal = manual.length;
    const manualDone  = manual.filter(r => r.complete).length;

    // Portfolio scope: if a specific staff filter is selected, show that person's portfolio.
    // If team filter is set without a staff filter, portfolio is excluded (teams don't map to portfolios).
    const staffFilter = $("#filterStaff")?.value || "";
    const teamFilter  = $("#filterTeam")?.value || "";

    let portTotal = 0, portDone = 0;
    try{
      if(staffFilter){
        const p = await computePortfolioProgress(staffFilter);
        portTotal = p.total; portDone = p.compliant;
      }else if(!teamFilter){
        const p = await computePortfolioProgress(null);
        portTotal = p.total; portDone = p.compliant;
      }
    }catch(e){
      // Don't kill the UI if portfolios aren't configured yet
      console.warn("Portfolio progress failed:", e);
    }

    if(req !== _progressReq) return; // stale

    const total = portTotal + manualTotal;
    const done  = portDone  + manualDone;
    const pct   = total ? Math.round((done/total)*100) : 0;

    const parts = [];
    parts.push(`Compliance: ${portDone}/${portTotal}`);
    parts.push(`Tasks: ${manualDone}/${manualTotal}`);
    setProgress(pct, parts.join("  •  "));
  }


  function renderTasks(){
    const ft=$("#filterTeam").value;
    const fs=$("#filterStaff").value;
    const st=$("#filterStatus").value;
    const q=$("#searchBox").value.trim().toLowerCase();

    const rows = (cache.tasks||[])
      .map(t=>({ t, complete: isTaskComplete(t.id) }))
      .map(r=>({ ...r, rag: rag(r.t, r.complete) }))
      .filter(r=>{
        if(ft && r.t.target_team_id !== ft) return false;
        if(fs && r.t.target_staff_id !== fs && r.t.owner_staff_id !== fs) return false;
        if(st==="open" && r.complete) return false;
        if(st==="complete" && !r.complete) return false;
        if(q){
          const hay = `${(r.t.title||"")} ${(r.t.description||"")}`.toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

    renderTaskKpis(rows);

    // Update progress bar (tasks + portfolios)
    updateProgress(rows);

    $("#taskTbody").innerHTML = rows.map(r=>{
      const due = (r.t.task_type==="quarterly" && r.t.quarter) ? r.t.quarter : (r.t.due_at ? fmtDate(r.t.due_at) : "");
      const teamName  = r.t.target_team_id  ? nameForTeam(r.t.target_team_id)  : "";
const staffName = r.t.target_staff_id ? nameForStaff(r.t.target_staff_id) : "";

let target = "All";
if (teamName && staffName) {
  target = `Team: ${escapeHtml(teamName)} • Staff: ${escapeHtml(staffName)}`;
} else if (teamName) {
  target = `Team: ${escapeHtml(teamName)}`;
} else if (staffName) {
  target = `Staff: ${escapeHtml(staffName)}`;
}
      const owner = escapeHtml(nameForStaff(r.t.owner_staff_id)||"");
      const pill = `<span class="pill"><span class="dot ${r.rag}"></span><span>${r.rag.toUpperCase()}</span></span>`;

      const canCtrl = (me.mode==="controller" && me.staff_id);
      const canAuth = (me.mode==="auth" && me.user_id);

      const btnOpen = `<button class="btn sm ghost" data-act="open" data-id="${r.t.id}">Open</button>`;
      const btnComplete = (!r.complete) ? `<button class="btn sm" data-act="complete" data-id="${r.t.id}" ${!canCtrl ? "disabled title=\"Select controller name to complete\"" : ""}>Complete</button>` : (r.complete?`<span class="mini muted">Done</span>`:"");
      const btnUndo = (r.complete && canAuth) ? `<button class="btn sm ghost" data-act="undo" data-id="${r.t.id}">Undo</button>` : "";

      return `<tr data-id="${r.t.id}">
        <td>${pill}</td>
        <td><div class="tTitle">${escapeHtml(r.t.title||"")}${r.t.task_type==="compliance" ? ` <span class="pill" title="Auto-generated compliance task"><span class="dot grey"></span><span class="mini">COMPLIANCE</span></span>` : ""}</div><div class="mini muted">${escapeHtml(r.t.description||"")}</div></td>
        <td>${escapeHtml(due)}</td>
        <td>${escapeHtml(target)}</td>
        <td>${owner}</td>
        <td><div class="row" style="gap:.35rem; flex-wrap:wrap">${btnOpen}${btnComplete}${btnUndo}</div></td>
      </tr>`;
    }).join("");
  }

  function setWhoLabel(){
    const authed = !!me.user_id;
    const label = authed ? `SNDM: ${me.display_name || me.user_id.slice(0,8)}` : (me.staff_id ? `Controller: ${nameForStaff(me.staff_id)}` : "Controller view");
    $("#whoLabel").textContent = label;

    $("#createBtnTop").classList.toggle("hide", !(authed && me.role==="sndm"));
    $("#logoutBtnTop").classList.toggle("hide", !authed);
    $("#loginBtnTop").classList.toggle("hide", authed);
  

    // Compliance pages: keep KISS - visible only for SNDM when logged in
    const showComplianceLinks = (authed && me.role==="sndm");
    const aL = document.getElementById("auditLink");
    const adL = document.getElementById("adminLink");
    if(aL) aL.classList.toggle("hide", !showComplianceLinks);
    if(adL) adL.classList.toggle("hide", !showComplianceLinks);
  }

  function showAuthCard(show){ $("#authCard").classList.toggle("hide", !show); }

  function renderDetail(task_id){
    selectedTaskId = task_id;
    const t = cache.tasks.find(x=>x.id===task_id);
    if(!t){
      $("#detailTitle").textContent="Select a task";
      $("#detailSub").textContent="";
      $("#detailBody").textContent="Select a task to view notes and actions.";
      return;
    }
    $("#detailTitle").textContent = t.title || "Task";
    $("#detailSub").textContent = isTaskComplete(task_id) ? "Complete" : "Open";

    const notes = cache.notesByTask.get(task_id) || [];
    const complete = isTaskComplete(task_id);
    const canAuth = (me.mode==="auth" && me.user_id);

    const notesHtml = notes.length
      ? `<div style="display:flex; flex-direction:column; gap:.5rem; margin-top:.5rem;">
          ${notes.map(n=>`<div class="subtle" style="padding:.6rem .7rem;">
            <div class="mini muted">${fmtDate(n.created_at)} ${n.author_user_id ? "(SNDM)" : ""}</div>
            <div>${escapeHtml(n.note||"")}</div>
          </div>`).join("")}
        </div>`
      : `<div class="mini muted" style="margin-top:.5rem;">No notes yet.</div>`;

    const addBtn = `<button class="btn sm" id="addNoteBtn" style="margin-top:.6rem;">Add note</button>`;

    $("#detailBody").innerHTML = `
      <div class="mini muted">${escapeHtml(t.description||"")}</div>
      <div class="hr"></div>
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <span class="pill"><span class="dot ${complete ? "green":"grey"}"></span><span>${complete ? "Complete":"Open"}</span></span>
        <span class="pill"><span class="mini muted">Due</span> <b>${escapeHtml((t.task_type==="quarterly" && t.quarter) ? t.quarter : (t.due_at ? fmtDate(t.due_at) : "—"))}</b></span>
      </div>
      ${addBtn}
      ${notesHtml}
    `;

    const add = $("#addNoteBtn");
    if(add){
      add.onclick = async ()=>{
        const note = prompt("Add note:");
        if(!note || !note.trim()) return;
        // Any user can add notes. If logged in, we store author_user_id. If in controller mode, we store null and prefix the note with the controller name.
        let authorLabel = "";
        if(me.user_id){
          authorLabel = me.display_name ? `SNDM:${me.display_name}` : `SNDM:${me.user_id.slice(0,8)}`;
        }else if(me.staff_id){
          authorLabel = `CTRL:${nameForStaff(me.staff_id)}`;
        }else{
          const who = prompt("Your name (for note attribution):");
          if(!who || !who.trim()) return;
          authorLabel = `CTRL:${who.trim()}`;
        }

        const payload = {
          task_id,
          note: `[${authorLabel}] ${note.trim()}`,
          author_user_id: me.user_id || null
        };

        const ins = await sb.schema("cck").from("task_notes").insert(payload);
        if(ins.error) return toast(ins.error.message);
        await refreshAll(false);
        renderDetail(task_id);
      };
    }
  }

  async function markComplete(task_id){
    if(!(me.mode==="controller" && me.staff_id)) return toast("Select your name (controller) to complete tasks.");
    const res = await sb.schema("cck").from("task_completions")
      .upsert({ task_id, completed:true }, { onConflict:"task_id" });
    if(res.error) return toast(res.error.message);
    await refreshAll(false);
    renderDetail(task_id);
    toast("Marked complete");
  }

  async function undoComplete(task_id){
    if(!(me.mode==="auth" && me.user_id)) return toast("SNDM login required to undo completion.");
    const res = await sb.schema("cck").from("task_completions")
      .upsert({ task_id, completed:false, completed_by_user_id: me.user_id }, { onConflict:"task_id" });
    if(res.error) return toast(res.error.message);
    await refreshAll(false);
    renderDetail(task_id);
    toast("Completion reversed");
  }

  async function doLogin(){
    const email = $("#email").value.trim();
    const pass = $("#pass").value;
    const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
    if(error) return toast(error.message);

    me.user_id = data.user.id;
    me.mode = "auth";

    const prof = await sb.schema("cck").from("profiles").select("display_name,role").eq("user_id", me.user_id).single();
    if(!prof.error && prof.data){
      me.display_name = prof.data.display_name;
      me.role = prof.data.role;
    }else{
      me.display_name = email;
      me.role = "sndm";
    }
    showAuthCard(false);
    setWhoLabel();
    toast("Logged in");
    renderTasks();
  }

  async function doLogout(){
    try{ await sb.auth.signOut(); }catch(e){}
    me.user_id=null; me.role=null; me.display_name=null; me.mode="controller";
    setWhoLabel();
    toast("Logged out");
    renderTasks();
  }

  function openCreate(){
    if(!(me.mode==="auth" && me.user_id && me.role==="sndm")) return toast("SNDM login required to create tasks.");
    $("#createModal").classList.remove("hide");
  }

  async function createTask(){
    if(!(me.mode==="auth" && me.user_id && me.role==="sndm")) return toast("SNDM login required.");
    const title=$("#c_title").value.trim();
    if(!title) return toast("Title required.");

    const type=$("#c_type").value;
    const due=$("#ct_due").value;
    const q=$("#ct_quarter").value.trim();

    const payload = {
      title,
      description: $("#c_desc").value.trim(),
      task_type: type,
      due_at: (type==="dated" && due) ? new Date(due).toISOString() : null,
      quarter: (type==="quarterly" ? (q || null) : null),
      target_team_id: $("#ct_targetTeam").value || null,
      target_staff_id: $("#ct_targetStaff").value || null,
      owner_staff_id: $("#ct_owner").value || null
    };

    const res = await sb.schema("cck").from("tasks").insert(payload);
    if(res.error) return toast(res.error.message);

    $("#createModal").classList.add("hide");
    $("#c_title").value=""; $("#c_desc").value=""; $("#ct_due").value=""; $("#ct_quarter").value="";
    await refreshAll(false);
    toast("Task created");
  }

  async function refreshAll(showToast=true){
    try{
      await loadReference();
      renderFilters();
      await loadTasks();
      renderTasks();
      if(selectedTaskId) renderDetail(selectedTaskId);
      setWhoLabel();
      if(showToast) toast("Refreshed");
    }catch(e){
      setConn(false);
      toast(e.message || String(e));
    }
  }

  function bind(){
    $("#loginBtnTop").addEventListener("click", ()=>{ showAuthCard(true); $("#email").focus(); });
    $("#logoutBtnTop").addEventListener("click", doLogout);
    $("#createBtnTop").addEventListener("click", openCreate);

    $("#authCancel").addEventListener("click", ()=>showAuthCard(false));
    $("#doLogin").addEventListener("click", doLogin);

    $("#enterController").addEventListener("click", ()=>{
      const v=$("#controllerStaff").value;
      if(!v) return toast("Pick your name.");
      me.staff_id = v;
      me.mode="controller";
      setWhoLabel();
      toast("Controller set");
      renderTasks();
    });
    $("#exitController").addEventListener("click", ()=>{
      me.staff_id = null;
      me.mode="controller";
      setWhoLabel();
      toast("Controller cleared");
      renderTasks();
    });

    $("#refreshBtn").addEventListener("click", ()=>refreshAll(true));
    $("#filterTeam").addEventListener("change", renderTasks);
    $("#filterStaff").addEventListener("change", renderTasks);
    $("#filterStatus").addEventListener("change", renderTasks);
    $("#searchBox").addEventListener("input", renderTasks);

    $("#taskTbody").addEventListener("click", (ev)=>{
      const btn = ev.target.closest("button");
      const tr = ev.target.closest("tr");
      const id = (btn && btn.dataset && btn.dataset.id) || (tr && tr.dataset && tr.dataset.id);
      if(!id) return;
      const act = btn && btn.dataset ? btn.dataset.act : null;
      if(act==="complete") return markComplete(id);
      if(act==="undo") return undoComplete(id);
      renderDetail(id);
    });

    const syncCreateType = ()=>{
      const v=$("#c_type").value;
      $("#dueWrap").classList.toggle("hide", v!=="dated");
      $("#qWrap").classList.toggle("hide", v!=="quarterly");
    };
    $("#c_type").addEventListener("change", syncCreateType);
    syncCreateType();

    $("#c_cancel").addEventListener("click", ()=>$("#createModal").classList.add("hide"));
    $("#c_cancel2").addEventListener("click", ()=>$("#createModal").classList.add("hide"));
    $("#c_create").addEventListener("click", createTask);

    setWhoLabel();
  }

  (async function boot(){
  if(!initSupabase()) return;
  setConn(true);
  bind();

  // ✅ Hybrid compliance sweep: run first, then refresh so new tasks appear immediately
  await runComplianceMonitorAllEnabled().catch(()=>{});
  await refreshAll(false);
})();
</script>

</body>
</html>

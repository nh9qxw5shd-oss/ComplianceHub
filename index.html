<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Control Compliance Hub (V1)</title>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* === Remembered theme (Winter Points Logbook-ish) === */
    :root{
      --bg: #f3f4f6;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --header:#111827;
      --headerInk:#f9fafb;
      --line:#e5e7eb;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 1px 2px rgba(0,0,0,.05);
      --radius: 14px;
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    header{
      background: var(--header);
      color: var(--headerInk);
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    header h1{
      font-size: 16px;
      margin:0;
      letter-spacing:.2px;
    }
    header .meta{
      display:flex;
      gap:10px;
      align-items:center;
      font-size: 12px;
      opacity: .92;
      flex-wrap: wrap;
      justify-content:flex-end;
      text-align:right;
    }
    header .pill{
      border: 1px solid rgba(255,255,255,.18);
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
    }

header button.pill{
  color: #f9fafb;              /* force light text */
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.18);
}

header button.pill:hover{
  background: rgba(255,255,255,.14);
}

    .wrap{
      max-width: 1280px;
      margin: 18px auto;
      padding: 0 14px 30px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .card h2{
      margin:0 0 10px;
      font-size: 14px;
      letter-spacing: .2px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 12px;
    }

    label{
      font-size: 12px;
      color: var(--muted);
    }

    input, select, textarea, button{
      font: inherit;
    }

    input[type="text"], input[type="email"], input[type="password"], select, textarea{
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      background:#fff;
      font-size: 13px;
      outline:none;
      min-width: 180px;
    }
    textarea{
      min-width: 260px;
      min-height: 80px;
      resize: vertical;
    }

    button{
      border: 1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor:pointer;
    }
    button.primary{
      background: #111827;
      color:#f9fafb;
      border-color:#111827;
    }
    button.danger{
      background: #fee2e2;
      border-color:#fecaca;
      color:#991b1b;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom: 10px;
    }
    .tab{
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background:#fff;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:#111827;
      color:#f9fafb;
      border-color:#111827;
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12.5px;
    }
    th, td{
      border-top: 1px solid var(--line);
      padding: 8px 6px;
      vertical-align: top;
      text-align:left;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      background:#fafafa;
      border-top: 1px solid var(--line);
    }
    .small{ font-size: 12px; color: var(--muted); }
    .muted{ color: var(--muted); }

    .dot{
      width: 10px; height:10px; border-radius:50%;
      display:inline-block; margin-right: 6px; vertical-align: middle;
      background: var(--muted);
    }
    .dot.good{ background: var(--good); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--bad); }

    .bar{
      height: 10px;
      background:#e5e7eb;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid var(--line);
    }
    .bar > div{
      height:100%;
      width:0%;
      background:#111827;
    }
    .kpi{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .rightCol .card{ margin-bottom: 14px; }
    .hide{ display:none !important; }

    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      background: #111827;
      color:#f9fafb;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,.18);
      font-size: 13px;
      max-width: 420px;
      display:none;
      z-index:9999;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .hint{
      border-left: 3px solid var(--line);
      padding-left: 10px;
      margin-top: 10px;
    }

    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
      .split{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<header>
  <h1>Control Compliance Hub (V1)</h1>
  <div class="meta">
    <span class="pill" id="envPill">Mini Project Hub (Supabase schema: compliance)</span>
    <span class="pill" id="userPill">Not signed in</span>
    <button id="signOutBtn" class="pill" style="display:none;">Sign out</button>
  </div>
</header>

<div class="wrap">

  <!-- AUTH CARD -->
  <div class="card" id="authCard">
    <h2>Sign in</h2>
    <div class="row">
      <div>
        <label>Email</label><br/>
        <input id="authEmail" type="email" placeholder="name@domain.com" autocomplete="username"/>
      </div>
      <div>
        <label>Password</label><br/>
        <input id="authPass" type="password" placeholder="••••••••" autocomplete="current-password"/>
      </div>
      <div style="margin-top:18px;">
        <button class="primary" id="signInBtn">Sign in</button>
        <button id="magicBtn" style="margin-left:8px;">Email link</button>
      </div>
    </div>

    <div class="hint small">
      <div><b>Heads up:</b> this page won’t “bypass auth” anymore because that’s how data leaks happen.</div>
      <div>Use Supabase Auth users, and roles live in <code>compliance.profiles.role</code> (sndm / rcm / staff).</div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="hide">
    <div class="controls">
      <div class="row">
        <div>
          <label>Year</label><br/>
          <select id="yearSel"></select>
        </div>
        <div>
          <label>Quarter</label><br/>
          <select id="qSel">
            <option value="1">Q1</option>
            <option value="2">Q2</option>
            <option value="3">Q3</option>
            <option value="4">Q4</option>
          </select>
        </div>
        <div>
          <label>Team (RCM)</label><br/>
          <select id="teamSel"></select>
        </div>
        <div>
          <label>Staff filter</label><br/>
          <select id="staffSel"></select>
        </div>
        <div>
          <label>Search</label><br/>
          <input id="searchBox" type="text" placeholder="task / tag / brief…"/>
        </div>
      </div>

      <div class="row">
        <div class="pill" id="periodPill">Period: -</div>
        <div class="pill" id="rolePill">Role: -</div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="compliance">Compliance</div>
      <div class="tab" data-tab="briefs">Briefing Hub</div>
      <div class="tab" data-tab="projects">Projects</div>
      <div class="tab" data-tab="people" id="peopleTab">People (SNDM)</div>
      <div class="tab" data-tab="teams" id="teamsTab">Team Builder (SNDM)</div>
      <div class="tab" data-tab="admin" id="adminTab">Task Admin (SNDM)</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div>

        <!-- COMPLIANCE -->
        <div class="card" id="tab-compliance">
          <div class="kpi">
            <h2>Compliance Tasks</h2>
            <div style="min-width: 380px;">
              <div class="bar" title="Actual progress (completed / total)">
                <div id="actualBar"></div>
              </div>
              <div class="small" id="progressText" style="margin-top:6px;">-</div>
              <div class="small" id="expectedText">-</div>
            </div>
          </div>

          <div style="margin-top:10px; overflow:auto;">
            <table>
              <thead>
              <tr>
                <th style="width:30px;">Done</th>
                <th>Task</th>
                <th style="width:140px;">Team</th>
                <th style="width:190px;">Tagged Staff</th>
                <th style="width:140px;">Tags</th>
                <th style="width:120px;">Due</th>
                <th style="width:90px;">Status</th>
                <th style="width:160px;">Linked Brief</th>
              </tr>
              </thead>
              <tbody id="tasksTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- BRIEFS -->
        <div class="card hide" id="tab-briefs">
          <div class="controls" style="margin-bottom:10px;">
            <h2 style="margin:0;">Briefing Hub</h2>
            <div class="row" id="briefUploadRow">
              <input id="briefFile" type="file"/>
              <input id="briefTitle" type="text" placeholder="Brief title"/>
              <input id="briefTags" type="text" placeholder="Tags (comma)"/>
              <button class="primary" id="uploadBriefBtn">Upload brief</button>
            </div>
          </div>

          <div style="overflow:auto;">
            <table>
              <thead>
              <tr>
                <th>Brief</th>
                <th style="width:320px;">Description</th>
                <th style="width:120px;">Tags</th>
                <th style="width:120px;">Uploaded</th>
                <th style="width:160px;">Actions</th>
                <th style="width:140px;">Read & Understood</th>
              </tr>
              </thead>
              <tbody id="briefsTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- PROJECTS -->
        <div class="card hide" id="tab-projects">
          <div class="controls" style="margin-bottom:10px;">
            <h2 style="margin:0;">RCM Personal Projects</h2>
            <div class="row">
              <input id="projTitle" type="text" placeholder="Project title"/>
              <select id="projStatus">
                <option value="planned">Planned</option>
                <option value="active" selected>Active</option>
                <option value="blocked">Blocked</option>
                <option value="done">Done</option>
              </select>
              <button class="primary" id="addProjBtn">Add</button>
            </div>
          </div>

          <div id="projectsList" class="split"></div>
          <p class="small" style="margin-top:10px;">
            Projects are owned by you. No shared ownership yet, because humans can’t share crisps without conflict.
          </p>
        </div>

        
<!-- PEOPLE MANAGER -->
<div class="card hide" id="tab-people">
  <h2>People (SNDM)</h2>
  <p class="small" style="margin-top:-6px;">
    Manage profiles and team membership here so nobody needs to poke the backend with a stick.
  </p>

  <div class="row" style="margin-bottom:10px;">
    <button class="primary" id="reloadPeopleBtn">Reload people</button>
    <button id="createUserBtn">Create user (Auth)</button>
    <span class="small muted">Create user requires an Edge Function (service role). See SQL/steps below.</span>
  </div>

  <div style="overflow:auto;">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th style="width:220px;">User ID</th>
          <th style="width:120px;">Role</th>
          <th style="width:220px;">Team</th>
          <th style="width:220px;">Actions</th>
        </tr>
      </thead>
      <tbody id="peopleTbody"></tbody>
    </table>
  </div>
</div>

<!-- TEAM BUILDER -->
        <div class="card hide" id="tab-teams">
          <h2>Team Builder (SNDM)</h2>
          <div class="row">
            <input id="teamName" type="text" placeholder="Team name (e.g. WH RCM A)"/>
            <select id="teamRcmUser"></select>
            <button class="primary" id="createTeamBtn">Create team</button>
          </div>

          <div style="margin-top:10px; overflow:auto;">
            <table>
              <thead>
              <tr>
                <th>Team</th>
                <th style="width:180px;">RCM</th>
                <th>Members</th>
                <th style="width:260px;">Add member</th>
                <th style="width:120px;">Actions</th>
              </tr>
              </thead>
              <tbody id="teamsTbody"></tbody>
            </table>
          </div>
        </div>

        <!-- ADMIN TASKS -->
        <div class="card hide" id="tab-admin">
          <h2>Task Admin (SNDM)</h2>
          <p class="small" style="margin-top:-6px;">
            Core compliance tasks live here. RCM can only mark completion, not edit the task definition.
          </p>

          <div class="row">
            <input id="taskTitle" type="text" placeholder="Task title (required)"/>

            <select id="taskTargetType" title="Where does this task apply?">
              <option value="team_one" selected>Specific team</option>
              <option value="team_all">All teams</option>
              <option value="person_one">Specific person</option>
              <option value="person_all">All people</option>
            </select>

            <select id="taskTargetTeam" title="Team target"></select>
            <select id="taskTargetPerson" title="Person target"></select>

            <select id="taskOwner" title="Owner (optional)"></select>
            <select id="taskDueMode" title="Scheduling mode">
              <option value="quarter" selected>Quarter-based</option>
              <option value="date">Specific date</option>
            </select>

            <select id="taskPeriodYear" title="Year (for quarter-based)"></select>
            <select id="taskPeriodQuarter" title="Quarter (for quarter-based)">
              <option value="1">Q1</option>
              <option value="2">Q2</option>
              <option value="3">Q3</option>
              <option value="4">Q4</option>
            </select>

            <input id="taskDueDate" type="date" title="Due date (for specific date)" class="hide"/>
<input id="taskTags" type="text" placeholder="Tags (optional, comma)"/>

            <button class="primary" id="createTaskBtn">Create task(s)</button>
          </div>

          <div class="small" style="margin-top:8px;">
            Choose scheduling: quarter-based (select Year + Quarter) or specific date (calendar). If you pick a date, the task is automatically filed into the matching quarter.
          </div>

          <div style="margin-top:10px; overflow:auto;">
            <table>
              <thead>
              <tr>
                <th>Task</th>
                <th style="width:140px;">Tags</th>
                <th style="width:110px;">Due</th>
                <th style="width:140px;">Team</th>
                <th style="width:110px;">Period</th>
                <th style="width:180px;">Actions</th>
              </tr>
              </thead>
              <tbody id="adminTasksTbody"></tbody>
            </table>
          </div>
        </div>

      </div>

      <!-- RIGHT -->
      <div class="rightCol">

        <div class="card">
          <h2>Operational Snapshot</h2>
          <div class="small" id="snapshotText">Loading…</div>
          <div style="margin-top:10px;">
            <div class="small muted">This is V1. It’s meant to run the basics, not solve the human condition.</div>
          </div>
        </div>
</div>
<p class="small" style="margin-top:10px;">
            Auto-refresh runs every 10 seconds once signed in.
          </p>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/**
 * ===========================
 * SUPABASE CONFIG (EDIT THIS)
 * ===========================
 * This is meant for the Mini Project Hub: keep all tables in schema = 'compliance'
 * and do NOT touch other apps.
 */
const APP_SCHEMA = "compliance";
const RAW_SUPABASE_URL = "https://ungtmfwxqawkdiflmora.supabase.co"; // keep your configured value
const SUPABASE_URL = (() => {
  let u = (RAW_SUPABASE_URL || "").trim();
  // Allow users to paste just the host without scheme
  if (u && !/^https?:\/\//i.test(u)) u = "https://" + u;
  // Strip trailing slash
  u = u.replace(/\/+$/, "");
  // Basic sanity check: Supabase project URLs normally end with ".supabase.co"
  try {
    const host = new URL(u).hostname || "";
    if (!host.endsWith(".supabase.co")) {
      console.error("SUPABASE_URL looks wrong:", u);
      // We don't hard-stop, but we surface it clearly
      window.__SUPABASE_URL_WARNING__ = "Project URL doesn’t look like a Supabase URL (should end with .supabase.co). Check Settings → API → Project URL.";
    }
  } catch (e) {
    console.error("SUPABASE_URL is not a valid URL:", u, e);
    window.__SUPABASE_URL_WARNING__ = "Project URL is not a valid URL. Check Settings → API → Project URL.";
  }
  return u;
})();

const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuZ3RtZnd4cWF3a2RpZmxtb3JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDY4NjQsImV4cCI6MjA3NzY4Mjg2NH0.Yaq0XfbbkwxJDUoiPCS7bLVBy70Wa-NOOWIxkpRRxdc";

const SupabaseLib = (window.supabase && window.supabase.createClient) ? window.supabase
  : (window.supabaseJs && window.supabaseJs.createClient) ? window.supabaseJs
  : (window.supabasejs && window.supabasejs.createClient) ? window.supabasejs
  : (window.Supabase && window.Supabase.createClient) ? window.Supabase
  : null;

let sb = null;
if(!SupabaseLib){
  console.error("Supabase JS not loaded. Check the CDN <script> tag, CSP, or network filtering.");
  // Fail loudly so you don't click buttons into the void.
  alert("Supabase JS failed to load. Check network/CSP filtering (see console).");
} else {
  sb = SupabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  });
}

// Convenience: schema-qualified table handle
const db = (table) => sb.schema(APP_SCHEMA).from(table);

async function ensureSchemaExposed(){
  // Supabase API only exposes schemas listed in Settings → API → Exposed schemas.
  // If APP_SCHEMA isn't exposed, PostgREST returns 406 with PGRST106.
  if(!sb) return false;
  if(APP_SCHEMA === "public") return true;

  // Probe the schema without assuming any table exists yet.
  const probe = await sb.schema(APP_SCHEMA).from("profiles").select("user_id").limit(1);
  const err = probe?.error;
  if(err && (err.code === "PGRST106" || String(err.message||"").includes("schema must be one of"))){
    console.error("Schema not exposed:", err);
    const msg = `Backend schema '${APP_SCHEMA}' is not exposed to the API. In Supabase: Settings → API → Exposed schemas → add '${APP_SCHEMA}', then reload.`;
    toast(msg);
    const hint = document.getElementById("schemaHint");
    if(hint){
      hint.innerHTML = `
        <span class="dot bad"></span>
        <b>Fix needed:</b> Your Supabase API is not exposing the <code>${APP_SCHEMA}</code> schema.<br/>
        Go to <b>Supabase → Settings → API → Exposed schemas</b> and add <code>${APP_SCHEMA}</code> (comma-separated).<br/>
        Then refresh this page.
      `;
    }
    return false;
  }
  return true;
}

const els = {
  authCard: document.getElementById("authCard"),
  app: document.getElementById("app"),
  email: document.getElementById("authEmail"),
  pass: document.getElementById("authPass"),
  signIn: document.getElementById("signInBtn"),
  magic: document.getElementById("magicBtn"),
  signOut: document.getElementById("signOutBtn"),
  userPill: document.getElementById("userPill"),
  rolePill: document.getElementById("rolePill"),
  envPill: document.getElementById("envPill"),

  yearSel: document.getElementById("yearSel"),
  qSel: document.getElementById("qSel"),
  teamSel: document.getElementById("teamSel"),
  staffSel: document.getElementById("staffSel"),
  searchBox: document.getElementById("searchBox"),
  periodPill: document.getElementById("periodPill"),

  tabs: document.getElementById("tabs"),
  teamsTab: document.getElementById("teamsTab"),
  adminTab: document.getElementById("adminTab"),
  peopleTab: document.getElementById("peopleTab"),

  tasksTbody: document.getElementById("tasksTbody"),
  briefsTbody: document.getElementById("briefsTbody"),
  projectsList: document.getElementById("projectsList"),
  teamsTbody: document.getElementById("teamsTbody"),
  adminTasksTbody: document.getElementById("adminTasksTbody"),
  peopleTbody: document.getElementById("peopleTbody"),

  reloadPeopleBtn: document.getElementById("reloadPeopleBtn"),
  createUserBtn: document.getElementById("createUserBtn"),

  actualBar: document.getElementById("actualBar"),
  progressText: document.getElementById("progressText"),
  expectedText: document.getElementById("expectedText"),

  snapshotText: document.getElementById("snapshotText"),
// Brief upload
  briefUploadRow: document.getElementById("briefUploadRow"),
  briefFile: document.getElementById("briefFile"),
  briefTitle: document.getElementById("briefTitle"),
  briefTags: document.getElementById("briefTags"),
  uploadBriefBtn: document.getElementById("uploadBriefBtn"),

  // Admin task create
  taskTitle: document.getElementById("taskTitle"),
  taskTags: document.getElementById("taskTags"),
  taskDueMode: document.getElementById("taskDueMode"),
  taskPeriodYear: document.getElementById("taskPeriodYear"),
  taskPeriodQuarter: document.getElementById("taskPeriodQuarter"),
  taskDueDate: document.getElementById("taskDueDate"),
  createTaskBtn: document.getElementById("createTaskBtn"),

  // Admin task targeting
  taskTargetType: document.getElementById("taskTargetType"),
  taskTargetTeam: document.getElementById("taskTargetTeam"),
  taskTargetPerson: document.getElementById("taskTargetPerson"),
  taskOwner: document.getElementById("taskOwner"),

  // Teams
  teamName: document.getElementById("teamName"),
  teamRcmUser: document.getElementById("teamRcmUser"),
  createTeamBtn: document.getElementById("createTeamBtn"),

  // Projects
  projTitle: document.getElementById("projTitle"),
  projStatus: document.getElementById("projStatus"),
  addProjBtn: document.getElementById("addProjBtn"),

  toast: document.getElementById("toast"),
};


// ---------- Debug helpers (so clicks don't "do nothing") ----------
window.addEventListener("error", (e)=> {
  try { toast("JS error: " + (e.message || "unknown")); } catch(_) {}
  console.error("JS error", e.error || e);
});
window.addEventListener("unhandledrejection", (e)=> {
  try { toast("Async error: " + (e.reason?.message || String(e.reason || "unknown"))); } catch(_) {}
  console.error("Unhandled promise rejection", e.reason);
});

let sessionUser = null;
let profile = null; // {user_id, display_name, role}
let teams = [];
let members = [];
let tasks = [];
let assignments = [];
let completions = [];
let briefs = [];
let briefReads = [];
let briefLinks = [];
let projects = [];
let projectNotes = [];
let projectCollabs = [];
let peopleProfiles = [];

let refreshTimer = null;

function toast(msg){
  els.toast.textContent = msg;
  els.toast.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> els.toast.style.display="none", 2600);
}

// Surface common config mistakes early
if (window.__SUPABASE_URL_WARNING__) {
  setTimeout(()=> toast(window.__SUPABASE_URL_WARNING__), 50);
}

function pad(n){ return String(n).padStart(2,"0"); }
function fmtDate(d){
  if(!d) return "";
  const x = new Date(d);
  return `${x.getUTCFullYear()}-${pad(x.getUTCMonth()+1)}-${pad(x.getUTCDate())}`;
}
function getQuarterWindow(year, q){
  const qStartMonth = (q-1)*3; // 0,3,6,9
  const start = new Date(Date.UTC(year, qStartMonth, 1, 0,0,0));
  const end = new Date(Date.UTC(year, qStartMonth+3, 1, 0,0,0)); // exclusive
  return { start, end };
}
function matchSearch(s, q){
  if(!q) return true;
  return (s||"").toLowerCase().includes(q.toLowerCase());
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

function roleIs(r){ return (profile?.role || "") === r; }
function roleIn(arr){ return arr.includes(profile?.role || ""); }

function setTab(tab){
  document.querySelectorAll(".tab").forEach(t=> t.classList.toggle("active", t.dataset.tab===tab));
  ["compliance","briefs","projects","people","teams","admin"].forEach(k=>{
    const el = document.getElementById("tab-"+k);
    if(el) el.classList.toggle("hide", k!==tab);
  });
}

function enforceRoleUI(){
  els.rolePill.textContent = `Role: ${profile?.role || "-"}`;
  els.peopleTab.style.display = roleIs("sndm") ? "" : "none";
  els.teamsTab.style.display = roleIs("sndm") ? "" : "none";
  els.adminTab.style.display = roleIs("sndm") ? "" : "none";

  els.briefUploadRow.style.display = roleIs("sndm") ? "flex" : "none";
  document.querySelector('[data-tab="projects"]').style.display = "";
  document.querySelector('[data-tab="compliance"]').style.display = roleIn(["rcm","sndm","staff"]) ? "" : "none";
  document.querySelector('[data-tab="briefs"]').style.display = roleIn(["rcm","sndm","staff"]) ? "" : "none";
}

async function signIn(){
  if(!sb) return toast("Supabase client not initialised. If you're on GitHub Pages, check the CDN isn't blocked.");
  const email = (els.email.value||"").trim();
  const password = els.pass.value || "";
  if(!email || !password) return toast("Email + password required.");

  els.signIn.disabled = true;
  els.signIn.textContent = "Signing in…";

  try{
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if(error) return toast(error.message);

    toast("Signed in.");
    await boot(); // force UI transition immediately
  } catch(err){
    console.error(err);
    toast(err?.message || String(err));
  } finally {
    els.signIn.disabled = false;
    els.signIn.textContent = "Sign in";
  }
}

async function sendMagicLink(){
  const email = els.email.value.trim();
  if(!email) return toast("Enter your email first.");
  // IMPORTANT: set the redirect URL in Supabase Auth settings to your GitHub Pages URL.
  const { error } = await sb.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: window.location.href }
  });
  if(error) return toast(error.message);
  toast("Magic link sent. Check your email.");
}

async function signOut(){
  if(!sb) {
    sessionUser = null;
    profile = null;
    els.app.classList.add("hide");
    els.authCard.classList.remove("hide");
    els.signOut.style.display = "none";
    els.userPill.textContent = "Not signed in";
    return toast("Signed out.");
  }
  await sb.auth.signOut();
  sessionUser = null;
  profile = null;
  els.app.classList.add("hide");
  els.authCard.classList.remove("hide");
  els.signOut.style.display = "none";
  els.userPill.textContent = "Not signed in";
  toast("Signed out.");
}

function initYearQuarter(){
  const now = new Date();
  const y = now.getUTCFullYear();
  els.yearSel.innerHTML = "";
  for(let yy=y-1; yy<=y+1; yy++){
    const opt = document.createElement("option");
    opt.value = yy;
    opt.textContent = yy;
    if(yy===y) opt.selected = true;
    els.yearSel.appendChild(opt);
  }
  const m = now.getUTCMonth(); // 0-11
  const q = Math.floor(m/3)+1;
  els.qSel.value = String(q);
}

function updateTaskDueModeUI(){
  if(!els.taskDueMode) return;
  const mode = (els.taskDueMode.value || "quarter");
  const isQuarter = (mode === "quarter");
  els.taskPeriodYear.classList.toggle("hide", !isQuarter);
  els.taskPeriodQuarter.classList.toggle("hide", !isQuarter);
  els.taskDueDate.classList.toggle("hide", isQuarter);
}

function syncTaskAdminPeriodPickers(){
  if(!els.taskPeriodYear || !els.yearSel) return;
  // Copy year options from the main selector
  els.taskPeriodYear.innerHTML = els.yearSel.innerHTML;
  els.taskPeriodYear.value = els.yearSel.value;
  els.taskPeriodQuarter.value = els.qSel.value;
  updateTaskDueModeUI();
}


async function ensureProfile(){
  // Loads profile row, and creates one if missing (role defaults to 'staff' until an SNDM grants/changes it).
  const { data: sess } = await sb.auth.getSession();
  sessionUser = sess?.session?.user || null;
  if(!sessionUser) return null;

  const { data, error } = await db("profiles")
    .select("user_id, display_name, role")
    .eq("user_id", sessionUser.id)
    .maybeSingle();

  if(error){
    console.error(error);
    toast("Profile load failed. Check RLS / schema.");
    return null;
  }

  if(data) return data;

  // Create minimal profile
  const display = (sessionUser.email || "User").split("@")[0];
  const ins = await db("profiles").insert({
    user_id: sessionUser.id,
    display_name: display,
    role: "staff"
  });
  if(ins.error){
    console.error(ins.error);
    toast("Profile auto-create failed. Run the SQL bootstrap.");
    return null;
  }

  const { data: created } = await db("profiles")
    .select("user_id, display_name, role")
    .eq("user_id", sessionUser.id)
    .single();

  return created || null;
}

async function loadCore(){
  const year = Number(els.yearSel.value);
  const quarter = Number(els.qSel.value);

  const t1 = await db("teams").select("*").order("name", {ascending:true});
  teams = t1.data || [];

  const t2 = await db("team_members").select("*");
  members = t2.data || [];

  const t3 = await db("compliance_tasks")
    .select("*")
    .eq("year", year)
    .eq("quarter", quarter)
    .order("due_date", {ascending:true});
  tasks = t3.data || [];

  const t4 = await db("task_assignments").select("*");
  assignments = t4.data || [];

  const t5 = await db("task_completions").select("*");
  completions = t5.data || [];

  const t6 = await db("briefs").select("*").order("created_at",{ascending:false});
  briefs = t6.data || [];

  const t7 = await db("brief_reads").select("*");
  briefReads = t7.data || [];

  const t8 = await db("brief_task_links").select("*");
  briefLinks = t8.data || [];

// Projects + notes (everyone can have projects; visibility: owner, collaborator, or SNDM sees all)
const p = await db("rcm_projects").select("*").order("created_at",{ascending:false});
projects = p.data || [];

const n = await db("rcm_project_notes").select("*");
projectNotes = n.data || [];

// Collaborators
const c = await db("project_collaborators").select("*");
projectCollabs = c.data || [];

// People (SNDM only)
if(roleIs("sndm")){
  const ppl = await db("profiles").select("user_id, display_name, role").order("display_name",{ascending:true});
  peopleProfiles = ppl.data || [];
} else {
  peopleProfiles = [];
}

}

function buildSelectors(){
  // Team selector
  els.teamSel.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "all";
  optAll.textContent = "All teams";
  els.teamSel.appendChild(optAll);

  teams.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = t.name;
    if(roleIs("rcm") && t.rcm_user_id === sessionUser.id) opt.selected = true;
    els.teamSel.appendChild(opt);
  });

  rebuildStaffSelector();

  if(roleIs("sndm")){
    loadRcmUsersForTeamBuilder();
  }

  const year = Number(els.yearSel.value);
  const q = Number(els.qSel.value);
  const { start, end } = getQuarterWindow(year, q);
  els.periodPill.textContent = `Period: ${year} Q${q} (${fmtDate(start)} to ${fmtDate(new Date(end.getTime()-86400000))})`;

  // Keep Task Admin scheduling pickers aligned
  syncTaskAdminPeriodPickers();

}

async function loadRcmUsersForTeamBuilder(){
  const { data, error } = await db("profiles")
    .select("user_id, display_name, role")
    .in("role",["rcm","staff"]).order("display_name",{ascending:true});
  if(error) { console.error(error); return; }

  els.teamRcmUser.innerHTML = "";
  (data||[]).forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.user_id;
    opt.textContent = p.display_name || p.user_id;
    els.teamRcmUser.appendChild(opt);
  });
}

async function buildAdminTargetSelectors(){
  if(!roleIs("sndm")) return;
  // Teams
  els.taskTargetTeam.innerHTML = "";
  teams.forEach(t=>{
    const opt=document.createElement("option");
    opt.value=t.id;
    opt.textContent=t.name;
    els.taskTargetTeam.appendChild(opt);
  });

  // People (profiles)
  db("profiles").select("user_id, display_name, role").order("display_name",{ascending:true}).then(({data, error})=>{
    if(error){ console.error(error); return; }
    const list=data||[];

    // Target person dropdown
    els.taskTargetPerson.innerHTML = "";
    list.forEach(p=>{
      const opt=document.createElement("option");
      opt.value=p.user_id;
      opt.textContent=`${p.display_name || p.user_id} (${p.role})`;
      els.taskTargetPerson.appendChild(opt);
    });

    // Owner dropdown (optional)
    els.taskOwner.innerHTML = "";
    const none=document.createElement("option");
    none.value="";
    none.textContent="Owner (optional)";
    els.taskOwner.appendChild(none);
    list.forEach(p=>{
      const opt=document.createElement("option");
      opt.value=p.user_id;
      opt.textContent=`${p.display_name || p.user_id} (${p.role})`;
      els.taskOwner.appendChild(opt);
    });

    // Initial visibility
    syncAdminTargetVisibility();
  });
}

function syncAdminTargetVisibility(){
  if(!roleIs("sndm")) return;
  const t = els.taskTargetType.value;
  const showTeam = (t==="team_one" || t==="team_all");
  els.taskTargetTeam.style.display = showTeam ? "" : "none";
  els.taskTargetPerson.style.display = showTeam ? "none" : "";
}

async function rebuildStaffSelector(){
  const teamId = els.teamSel.value;
  els.staffSel.innerHTML = "";

  const a = document.createElement("option");
  a.value = "all";
  a.textContent = "All staff";
  els.staffSel.appendChild(a);

  let pool = members;
  if(teamId !== "all") pool = members.filter(m=> m.team_id === teamId);

  const userIds = [...new Set(pool.map(p=> p.user_id))];
  if(!userIds.length) return;

  const { data } = await db("profiles").select("user_id, display_name, role").in("user_id", userIds);
  (data||[]).forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.user_id;
    opt.textContent = `${p.display_name || p.user_id} (${p.role})`;
    els.staffSel.appendChild(opt);
  });
}

function teamName(teamId){
  const t = teams.find(x=> x.id===teamId);
  return t?.name || "Unknown";
}

function statusDot(completed, dueDateStr){
  if(completed) return `<span class="dot good"></span>Green`;
  if(!dueDateStr) return `<span class="dot warn"></span>Amber`;
  const now = new Date();
  const due = new Date(dueDateStr+"T00:00:00Z");
  const diffDays = Math.floor((due - now)/86400000);
  if(diffDays < 0) return `<span class="dot bad"></span>Red`;
  if(diffDays <= 7) return `<span class="dot warn"></span>Amber`;
  return `<span class="dot"></span>Grey`;
}

function getTaskTaggedStaff(taskId){
  return assignments.filter(a=> a.task_id===taskId).map(a=> a.user_id);
}
function isTaskCompleted(taskId){ return completions.some(c=> c.task_id===taskId); }
function completedAt(taskId){ return completions.find(x=> x.task_id===taskId)?.completed_at || null; }
function linkedBrief(taskId){
  const link = briefLinks.find(l=> l.task_id===taskId);
  if(!link) return null;
  return briefs.find(b=> b.id===link.brief_id) || null;
}

async function resolveNames(userIds){
  if(!userIds.length) return {};
  const { data } = await db("profiles").select("user_id, display_name").in("user_id", userIds);
  const map = {};
  (data||[]).forEach(p=> map[p.user_id] = p.display_name || p.user_id);
  return map;
}

function makeFileUrl(storagePath){
  // bucket = compliance_briefs (public). If you make it private, swap to createSignedUrl.
  const { data } = sb.storage.from("compliance_briefs").getPublicUrl(storagePath);
  return data?.publicUrl || "";
}

async function renderTasks(){
  const year = Number(els.yearSel.value);
  const quarter = Number(els.qSel.value);
  const teamId = els.teamSel.value;
  const staffId = els.staffSel.value;
  const q = els.searchBox.value.trim();

  let list = tasks.slice();
  if(teamId !== "all") list = list.filter(t=> t.team_id === teamId);

  if(staffId !== "all"){
    list = list.filter(t => getTaskTaggedStaff(t.id).includes(staffId));
  }

  if(q){
    list = list.filter(t => matchSearch(t.title, q) || matchSearch(t.tags, q));
  }

  if(roleIs("rcm")){
    const myTeamIds = teams.filter(t=> t.rcm_user_id === sessionUser.id).map(t=> t.id);
    list = list.filter(t=> myTeamIds.includes(t.team_id));
  }

  const total = list.length;
  const done = list.filter(t=> isTaskCompleted(t.id)).length;
  const pct = total ? Math.round((done/total)*100) : 0;
  els.actualBar.style.width = pct + "%";
  els.progressText.textContent = `Actual: ${done}/${total} (${pct}%) completed`;

  const { start, end } = getQuarterWindow(year, quarter);
  const now = new Date();
  const totalMs = end - start;
  const elapsedMs = Math.min(Math.max(now - start, 0), totalMs);
  const expectedRatio = totalMs ? (elapsedMs/totalMs) : 0;
  const expectedCount = Math.round(total * expectedRatio);
  els.expectedText.textContent = `Expected by today: ~${expectedCount}/${total} (${Math.round(expectedRatio*100)}%)`;

  const allTagged = [...new Set(list.flatMap(t=> getTaskTaggedStaff(t.id)))];
  const nameMap = await resolveNames(allTagged);

  els.tasksTbody.innerHTML = "";
  for(const t of list){
    const completed = isTaskCompleted(t.id);
    const tagIds = getTaskTaggedStaff(t.id);
    const tagNames = tagIds.map(id=> nameMap[id] || id).join(", ");
    const b = linkedBrief(t.id);
    const briefCell = b ? `${escapeHtml(b.title)}` : `<span class="muted">None</span>`;

    let canComplete = false;
    if(roleIs("sndm")) canComplete = true;
    if(roleIs("rcm")){
      const myTeamIds = teams.filter(x=> x.rcm_user_id === sessionUser.id).map(x=> x.id);
      canComplete = myTeamIds.includes(t.team_id);
    }

    const doneCell = completed
      ? `<button class="danger" data-undone="${t.id}" ${roleIs("staff")?"disabled":""}>Undo</button>`
      : `<button class="primary" data-done="${t.id}" ${(!canComplete)?"disabled":""}>Complete</button>`;

    const due = t.due_date ? t.due_date : "";
    const status = statusDot(completed, due);

    els.tasksTbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${doneCell}</td>
        <td>
          <div><b>${escapeHtml(t.title)}</b></div>
          <div class="small muted">${completed ? ("Completed: "+fmtDate(completedAt(t.id))) : ""}</div>
        </td>
        <td>${escapeHtml(teamName(t.team_id))}</td>
        <td>
          <div class="small">${escapeHtml(tagNames || "—")}</div>
          ${ roleIn(["sndm","rcm"]) ? `<button data-tag="${t.id}" style="margin-top:6px;">Tag staff</button>` : "" }
        </td>
        <td class="small">${escapeHtml(t.tags||"")}</td>
        <td class="small">${escapeHtml(due)}</td>
        <td class="small">${status}</td>
        <td class="small">
          ${briefCell}
          ${ roleIs("sndm") ? `<button data-linkbrief="${t.id}" style="margin-top:6px;">Link brief</button>` : "" }
        </td>
      </tr>
    `);
  }

  document.querySelectorAll("[data-done]").forEach(btn=>{
    btn.onclick = async ()=> completeTask(btn.dataset.done);
  });
  document.querySelectorAll("[data-undone]").forEach(btn=>{
    btn.onclick = async ()=> undoTask(btn.dataset.undone);
  });
  document.querySelectorAll("[data-tag]").forEach(btn=>{
    btn.onclick = async ()=> tagStaffToTask(btn.dataset.tag);
  });
  document.querySelectorAll("[data-linkbrief]").forEach(btn=>{
    btn.onclick = async ()=> linkBriefToTask(btn.dataset.linkbrief);
  });
}

async function completeTask(taskId){
  const already = completions.find(c=> c.task_id===taskId);
  if(already) return toast("Already completed.");
  const { error } = await db("task_completions").insert({
    task_id: taskId,
    completed_by: sessionUser.id,
    completed_at: new Date().toISOString()
  });
  if(error){ console.error(error); return toast(error.message); }
  toast("Task completed.");
  await refresh();
}

async function undoTask(taskId){
  const { error } = await db("task_completions").delete().eq("task_id", taskId);
  if(error){ console.error(error); return toast(error.message); }
  toast("Completion removed.");
  await refresh();
}

async function tagStaffToTask(taskId){
  const teamId = tasks.find(t=> t.id===taskId)?.team_id;
  const pool = members.filter(m=> m.team_id === teamId).map(m=> m.user_id);
  if(!pool.length) return toast("No team members to tag.");

  const nameMap = await resolveNames(pool);
  const choices = pool.map(id=> `${nameMap[id] || id} = ${id}`).join("\n");
  const picked = prompt("Paste the user_id to tag to this task (one at a time).\n\nChoices:\n"+choices);
  if(!picked) return;

  const { error } = await db("task_assignments").insert({
    task_id: taskId,
    user_id: picked.trim()
  });
  if(error){ console.error(error); return toast(error.message); }
  toast("Staff tagged.");
  await refresh();
}

async function linkBriefToTask(taskId){
  if(!briefs.length) return toast("No briefs yet.");
  const list = briefs.slice(0,40).map(b=> `${b.title} = ${b.id}`).join("\n");
  const picked = prompt("Paste the brief_id to link to this task:\n\n"+list);
  if(!picked) return;

  await db("brief_task_links").delete().eq("task_id", taskId);
  const { error } = await db("brief_task_links").insert({ task_id: taskId, brief_id: picked.trim() });
  if(error){ console.error(error); return toast(error.message); }
  toast("Brief linked.");
  await refresh();
}

async function renderBriefs(){
  const q = els.searchBox.value.trim();
  let list = briefs.slice();
  if(q){
    list = list.filter(b => matchSearch(b.title,q) || matchSearch(b.tags,q) || matchSearch(b.description,q));
  }

  els.briefsTbody.innerHTML = "";
  for(const b of list){
    const read = briefReads.some(r=> r.brief_id===b.id && r.user_id===sessionUser.id);
    const url = makeFileUrl(b.storage_path);

    const linkedTaskIds = briefLinks.filter(l=> l.brief_id===b.id).map(l=> l.task_id);
    const linkedNames = linkedTaskIds.map(tid=> tasks.find(x=> x.id===tid)?.title || "").filter(Boolean).slice(0,2).join(" | ");
    const linkedHint = linkedNames ? `<div class="small muted">Linked: ${escapeHtml(linkedNames)}</div>` : "";

    els.briefsTbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>
          <div><b>${escapeHtml(b.title)}</b></div>
          ${linkedHint}
          <div class="small muted">${escapeHtml(b.storage_path || "")}</div>
        </td>
        <td class="small">${escapeHtml(b.description || "")}</td>
        <td class="small">${escapeHtml(b.tags || "")}</td>
        <td class="small">${b.created_at ? fmtDate(b.created_at) : ""}</td>
        <td>
          <div class="row">
            <button data-view="${escapeAttr(url)}" ${!url ? "disabled":""}>View</button>
            <a href="${escapeAttr(url)}" download style="text-decoration:none;">
              <button ${!url ? "disabled":""}>Download</button>
            </a>
            ${ roleIs("sndm") ? `<button class="danger" data-delbrief="${b.id}">Delete</button>` : "" }
          </div>
        </td>
        <td>
          <button class="${read ? "" : "primary"}" data-read="${b.id}">
            ${read ? "Read" : "Mark read"}
          </button>
        </td>
      </tr>
    `);
  }

  document.querySelectorAll("[data-view]").forEach(btn=>{
    btn.onclick = ()=> openViewer(btn.dataset.view);
  });
  document.querySelectorAll("[data-read]").forEach(btn=>{
    btn.onclick = async ()=> markBriefRead(btn.dataset.read);
  });
  document.querySelectorAll("[data-delbrief]").forEach(btn=>{
    btn.onclick = async ()=> deleteBrief(btn.dataset.delbrief);
  });
}

function openViewer(url){
  if(!url) return toast("No URL (bucket not public or file missing).");
  window.open(url, "_blank", "noopener,noreferrer");
}

async function markBriefRead(briefId){
  const exists = briefReads.some(r=> r.brief_id===briefId && r.user_id===sessionUser.id);
  if(exists) return toast("Already marked read.");

  const { error } = await db("brief_reads").insert({
    brief_id: briefId,
    user_id: sessionUser.id,
    read_at: new Date().toISOString()
  });
  if(error){ console.error(error); return toast(error.message); }
  toast("Marked read.");
  await refresh();
}

async function deleteBrief(briefId){
  if(!confirm("Delete this brief?")) return;
  const { error } = await db("briefs").delete().eq("id", briefId);
  if(error){ console.error(error); return toast(error.message); }
  toast("Brief deleted.");
  await refresh();
}

async function uploadBrief(){
  const file = els.briefFile.files[0];
  const title = els.briefTitle.value.trim();
  const tags = els.briefTags.value.trim();
  if(!file || !title) return toast("File + title required.");

  const storagePath = `${new Date().toISOString().slice(0,10)}/${crypto.randomUUID()}_${file.name}`;
  const { error: upErr } = await sb.storage.from("compliance_briefs").upload(storagePath, file, {
    cacheControl: "3600",
    upsert: false
  });
  if(upErr){ console.error(upErr); return toast(upErr.message); }

  const desc = prompt("Brief description (what’s the point of this doc)?") || "";

  const { error: insErr } = await db("briefs").insert({
    title,
    description: desc,
    tags,
    storage_path: storagePath,
    created_by: sessionUser.id,
    created_at: new Date().toISOString()
  });
  if(insErr){ console.error(insErr); return toast(insErr.message); }

  els.briefFile.value = "";
  els.briefTitle.value = "";
  els.briefTags.value = "";
  toast("Brief uploaded.");
  await refresh();
}

async function renderProjects(){
  els.projectsList.innerHTML = "";

  // Visible projects: owner, collaborator, or SNDM sees all
  const visible = roleIs("sndm")
    ? projects.slice()
    : projects.filter(p => (p.owner_user_id === sessionUser.id) || projectCollabs.some(c=> c.project_id===p.id && c.user_id===sessionUser.id));

  if(!visible.length){
    els.projectsList.innerHTML = `<div class="card"><div class="small muted">No projects yet.</div></div>`;
    return;
  }

  
const projectUserIds = [...new Set([
  ...visible.map(p=> p.owner_user_id).filter(Boolean),
  ...projectCollabs.filter(c=> visible.some(p=>p.id===c.project_id)).map(c=> c.user_id)
])];
const projNameMap = await resolveNames(projectUserIds);

for(const p of visible){
    const notes = projectNotes.filter(n=> n.project_id===p.id).slice(0,5);
    const noteHtml = notes.map(n=> `<div class="small">• ${escapeHtml(n.note)} <span class="muted">(${fmtDate(n.created_at)})</span></div>`).join("");

    els.projectsList.insertAdjacentHTML("beforeend", `
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div><b>${escapeHtml(p.title)}</b></div>
            <div class="small muted">Status: ${escapeHtml(p.status || "")}</div>
            <div class="small muted">Owner: <b>${escapeHtml(projNameMap[p.owner_user_id] || p.owner_user_id || "—")}</b></div>
            <div class="small muted">Collaborators: ${escapeHtml(projectCollabs.filter(c=>c.project_id===p.id).map(c=> projNameMap[c.user_id] || c.user_id).join(", ") || "—")}</div>
          </div>
          <div class="row">
            <button data-note="${p.id}">Add note</button>
            <button data-addcollab="${p.id}">Add collaborator</button>
            <button data-remcollab="${p.id}">Remove collaborator</button>
            <button class="danger" data-delproj="${p.id}">Delete</button>
          </div>
        </div>
        <div style="margin-top:10px;">
          ${noteHtml || `<div class="small muted">No notes yet.</div>`}
        </div>
      </div>
    `);
  }

  document.querySelectorAll("[data-note]").forEach(btn=>{
    btn.onclick = async ()=> addProjectNote(btn.dataset.note);
  });
  document.querySelectorAll("[data-delproj]").forEach(btn=>{
    btn.onclick = async ()=> deleteProject(btn.dataset.delproj);
  });


document.querySelectorAll("[data-addcollab]").forEach(btn=>{
  btn.onclick = async ()=> addProjectCollaborator(btn.dataset.addcollab);
});
document.querySelectorAll("[data-remcollab]").forEach(btn=>{
  btn.onclick = async ()=> removeProjectCollaborator(btn.dataset.remcollab);
});

}

async function addProject(){
  const title = els.projTitle.value.trim();
  const status = els.projStatus.value;
  if(!title) return toast("Project title required.");

  const { error } = await db("rcm_projects").insert({
    owner_user_id: sessionUser.id,
    title,
    status,
    created_at: new Date().toISOString()
  });
  if(error){ console.error(error); return toast(error.message); }
  els.projTitle.value = "";
  toast("Project added.");
  await refresh();
}

async function addProjectNote(projectId){
  const note = prompt("Progress note:");
  if(!note) return;

  const { error } = await db("rcm_project_notes").insert({
    project_id: projectId,
    note,
    created_at: new Date().toISOString()
  });
  if(error){ console.error(error); return toast(error.message); }
  toast("Note added.");
  await refresh();
}


async function addProjectCollaborator(projectId){
  // Only owner or SNDM should do this
  const proj = projects.find(p=> p.id===projectId);
  if(!proj) return toast("Project not found.");
  if(!(roleIs("sndm") || proj.owner_user_id===sessionUser.id)) return toast("Not allowed.");

  const { data: ppl, error } = await db("profiles").select("user_id, display_name, role").order("display_name",{ascending:true});
  if(error) { console.error(error); return toast(error.message); }
  const list = (ppl||[]).map(p=> `${p.display_name || p.user_id} (${p.role}) = ${p.user_id}`).join("\n");
  const picked = prompt("Paste the user_id to add as collaborator:\n\n"+list);
  if(!picked) return;

  const userId = picked.trim();
  const { error: insErr } = await db("project_collaborators").insert({ project_id: projectId, user_id: userId });
  if(insErr){ console.error(insErr); return toast(insErr.message || "Failed"); }
  toast("Collaborator added.");
  await refresh();
}

async function removeProjectCollaborator(projectId){
  const proj = projects.find(p=> p.id===projectId);
  if(!proj) return toast("Project not found.");
  if(!(roleIs("sndm") || proj.owner_user_id===sessionUser.id)) return toast("Not allowed.");

  const current = projectCollabs.filter(c=> c.project_id===projectId).map(c=> c.user_id);
  if(!current.length) return toast("No collaborators.");
  const nameMap = await resolveNames(current);
  const list = current.map(id=> `${nameMap[id] || id} = ${id}`).join("\n");
  const picked = prompt("Paste the user_id to remove:\n\n"+list);
  if(!picked) return;

  const userId = picked.trim();
  const { error: delErr } = await db("project_collaborators").delete().eq("project_id", projectId).eq("user_id", userId);
  if(delErr){ console.error(delErr); return toast(delErr.message || "Failed"); }
  toast("Collaborator removed.");
  await refresh();
}

async function deleteProject(projectId){
  if(!confirm("Delete this project?")) return;
  await db("rcm_project_notes").delete().eq("project_id", projectId);
  const { error } = await db("rcm_projects").delete().eq("id", projectId);
  if(error){ console.error(error); return toast(error.message); }
  toast("Project deleted.");
  await refresh();
}

async function renderTeams(){
  if(!roleIs("sndm")) return;
  els.teamsTbody.innerHTML = "";

  const allUserIds = [...new Set([
    ...teams.map(t=> t.rcm_user_id),
    ...members.map(m=> m.user_id)
  ])];
  const nameMap = await resolveNames(allUserIds);

  for(const t of teams){
    const m = members.filter(x=> x.team_id===t.id);
    const memberText = m.map(x=> `${nameMap[x.user_id] || x.user_id} (${x.role_label||"member"})`).join(", ");

    els.teamsTbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td><b>${escapeHtml(t.name)}</b></td>
        <td class="small">${escapeHtml(nameMap[t.rcm_user_id] || t.rcm_user_id)}</td>
        <td class="small">${escapeHtml(memberText || "—")}</td>
        <td>
          <div class="row">
            <input type="text" data-addmemberid="${t.id}" placeholder="user_id"/>
            <select data-addmemberrole="${t.id}">
              <option value="IC">IC</option>
              <option value="TRC">TRC</option>
              <option value="Other">Other</option>
            </select>
            <button data-addmemberbtn="${t.id}">Add</button>
          </div>
        </td>
        <td>
          <button class="danger" data-delteam="${t.id}">Delete</button>
        </td>
      </tr>
    `);
  }

  document.querySelectorAll("[data-addmemberbtn]").forEach(btn=>{
    btn.onclick = async ()=>{
      const teamId = btn.dataset.addmemberbtn;
      const idInput = document.querySelector(`[data-addmemberid="${teamId}"]`);
      const roleSel = document.querySelector(`[data-addmemberrole="${teamId}"]`);
      const userId = (idInput.value||"").trim();
      const roleLabel = roleSel.value;
      if(!userId) return toast("user_id required.");
      const { error } = await db("team_members").insert({
        team_id: teamId,
        user_id: userId,
        role_label: roleLabel
      });
      if(error){ console.error(error); return toast(error.message); }
      toast("Member added.");
      await refresh();
    };
  });

  document.querySelectorAll("[data-delteam]").forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm("Delete this team?")) return;
      const teamId = btn.dataset.delteam;
      await db("team_members").delete().eq("team_id", teamId);
      const { error } = await db("teams").delete().eq("id", teamId);
      if(error){ console.error(error); return toast(error.message); }
      toast("Team deleted.");
      await refresh();
    };
  });
}

async function createTeam(){
  const name = els.teamName.value.trim();
  const rcmUserId = els.teamRcmUser.value;
  if(!name || !rcmUserId) return toast("Team name + RCM required.");

  const { error } = await db("teams").insert({ name, rcm_user_id: rcmUserId });
  if(error){ console.error(error); return toast(error.message); }
  els.teamName.value = "";
  toast("Team created.");
  await refresh();
}


async function renderPeople(){
  if(!roleIs("sndm")) return;
  els.peopleTbody.innerHTML = "";

  const teamMap = {};
  teams.forEach(t=> teamMap[t.id]=t.name);

  // Build current membership lookup (one primary team per person in V1)
  const memberByUser = {};
  members.forEach(m=>{
    if(!memberByUser[m.user_id]) memberByUser[m.user_id]=m; // first seen
  });

  for(const p of peopleProfiles){
    const m = memberByUser[p.user_id];
    const teamNameTxt = m ? (teamMap[m.team_id] || m.team_id) : "Unassigned";

    // Team dropdown
    const teamOpts = [`<option value="">Unassigned</option>`].concat(
      teams.map(t=> `<option value="${escapeAttr(t.id)}" ${m && m.team_id===t.id ? "selected":""}>${escapeHtml(t.name)}</option>`)
    ).join("");

    els.peopleTbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>
          <input type="text" data-pname="${escapeAttr(p.user_id)}" value="${escapeAttr(p.display_name||"")}" placeholder="Display name"/>
        </td>
        <td class="small">${escapeHtml(p.user_id)}</td>
        <td>
          <select data-prole="${escapeAttr(p.user_id)}">
            <option value="sndm" ${p.role==="sndm"?"selected":""}>sndm</option>
            <option value="rcm" ${p.role==="rcm"?"selected":""}>rcm</option>
            <option value="staff" ${p.role==="staff"?"selected":""}>staff</option>
          </select>
        </td>
        <td>
          <select data-pteam="${escapeAttr(p.user_id)}">
            ${teamOpts}
          </select>
          <div class="small muted">${escapeHtml(teamNameTxt)}</div>
        </td>
        <td class="row">
          <button data-psave="${escapeAttr(p.user_id)}">Save</button>
          <button class="danger" data-premoveteam="${escapeAttr(p.user_id)}">Remove team</button>
        </td>
      </tr>
    `);
  }

  document.querySelectorAll("[data-psave]").forEach(btn=>{
    btn.onclick = async ()=>{
      const uid = btn.dataset.psave;
      const nameEl = document.querySelector(`[data-pname="${uid}"]`);
      const roleEl = document.querySelector(`[data-prole="${uid}"]`);
      const teamEl = document.querySelector(`[data-pteam="${uid}"]`);
      await savePerson(uid, nameEl?.value||"", roleEl?.value||"staff", teamEl?.value||"");
    };
  });

  document.querySelectorAll("[data-premoveteam]").forEach(btn=>{
    btn.onclick = async ()=>{
      const uid = btn.dataset.premoveteam;
      await removePersonFromTeam(uid);
    };
  });
}

async function savePerson(userId, displayName, role, teamId){
  // Update profile
  const { error: uerr } = await db("profiles")
    .update({ display_name: displayName.trim(), role })
    .eq("user_id", userId);

  if(uerr){ console.error(uerr); return toast(uerr.message); }

  // Update team membership (simple: one row per user in V1)
  await db("team_members").delete().eq("user_id", userId);

  if(teamId){
    const { error: merr } = await db("team_members").insert({ team_id: teamId, user_id: userId, role_label: role.toUpperCase() });
    if(merr){ console.error(merr); return toast(merr.message); }
  }

  toast("Saved.");
  await refresh();
}

async function removePersonFromTeam(userId){
  const { error } = await db("team_members").delete().eq("user_id", userId);
  if(error){ console.error(error); return toast(error.message); }
  toast("Removed from team.");
  await refresh();
}

// Auth user creation requires Edge Function (service role). UI calls it if configured.
async function createAuthUser(){
  const email = prompt("Email for new user:");
  if(!email) return;
  const name = prompt("Display name:");
  const role = prompt("Role (sndm/rcm/staff):", "staff") || "staff";
  const password = prompt("Temporary password (tell them to change it):");
  if(!password) return;

  const fnUrl = (window.COMPLIANCE_ADMIN_FN_URL || "").trim();
  if(!fnUrl) return toast("Edge Function URL not configured. See setup notes.");

  const { data: sess } = await sb.auth.getSession();
  const jwt = sess?.session?.access_token;
  if(!jwt) return toast("You must be signed in.");

  const res = await fetch(fnUrl, {
    method: "POST",
    headers: { "Content-Type":"application/json", "Authorization": "Bearer "+jwt },
    body: JSON.stringify({ email, password, display_name: name||"", role })
  });
  const out = await res.json().catch(()=> ({}));
  if(!res.ok){ console.error(out); return toast(out.error || "Create user failed"); }
  toast("User created.");
  await refresh();
}

async function renderAdminTasks(){
  if(!roleIs("sndm")) return;
  const teamId = els.teamSel.value;

  let list = tasks.slice();
  if(teamId !== "all") list = list.filter(t=> t.team_id===teamId);

  els.adminTasksTbody.innerHTML = "";
  for(const t of list){
    els.adminTasksTbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td><b>${escapeHtml(t.title)}</b></td>
        <td class="small">${escapeHtml(t.tags||"")}</td>
        <td class="small">${escapeHtml(t.due_date||"")}</td>
        <td class="small">${escapeHtml(teamName(t.team_id))}</td>
        <td class="small">${t.year} Q${t.quarter}</td>
        <td class="row">
          <button class="danger" data-deltask="${t.id}">Delete</button>
        </td>
      </tr>
    `);
  }

  document.querySelectorAll("[data-deltask]").forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm("Delete this task?")) return;
      const id = btn.dataset.deltask;
      await db("task_assignments").delete().eq("task_id", id);
      await db("brief_task_links").delete().eq("task_id", id);
      await db("task_completions").delete().eq("task_id", id);
      const { error } = await db("compliance_tasks").delete().eq("id", id);
      if(error){ console.error(error); return toast(error.message); }
      toast("Task deleted.");
      await refresh();
    };
  });
}

async function createTask(){
  if(!roleIs("sndm")) return toast("Only SNDM can create tasks (for now).");

  const title = (els.taskTitle.value||"").trim();
  const tags = (els.taskTags.value||"").trim();
  const targetType = els.taskTargetType.value;
  const ownerUserId = (els.taskOwner.value||"").trim() || null;

  const dueMode = (els.taskDueMode.value||"quarter");
  let year = Number(els.taskPeriodYear.value || els.yearSel.value);
  let quarter = Number(els.taskPeriodQuarter.value || els.qSel.value);
  let due_date = null;

  if(dueMode === "date"){
    const picked = (els.taskDueDate.value||"").trim();
    if(!picked) return toast("Pick a due date.");
    const d = new Date(picked + "T00:00:00Z");
    year = d.getUTCFullYear();
    quarter = Math.floor(d.getUTCMonth()/3)+1;
    due_date = picked;
  }if(!title) return toast("Task title required.");

  // Build targets
  let targets = [];
  if(targetType === "team_one"){
    const teamId = els.taskTargetTeam.value;
    if(!teamId) return toast("Select a team.");
    targets = [{ team_id: teamId, primary_user_id: null }];
  }
  if(targetType === "team_all"){
    targets = teams.map(t=> ({ team_id: t.id, primary_user_id: null }));
  }
  if(targetType === "person_one"){
    const uid = els.taskTargetPerson.value;
    if(!uid) return toast("Select a person.");
    // Find their first team membership; if none, we still create but team_id null (requires SQL change) OR park it as unassigned (team_id null).
    const member = members.find(m=> m.user_id===uid);
    targets = [{ team_id: member?.team_id || null, primary_user_id: uid }];
  }
  if(targetType === "person_all"){
    // Everyone we know about (profiles), including unassigned.
    const { data: ppl, error } = await db("profiles").select("user_id");
    if(error){ console.error(error); return toast(error.message); }
    const ids = (ppl||[]).map(p=> p.user_id);
    targets = ids.map(uid=>{
      const member = members.find(m=> m.user_id===uid);
      return { team_id: member?.team_id || null, primary_user_id: uid };
    });
  }

  // Insert tasks (one per target)
  const rows = targets.map(t=>({
    team_id: t.team_id, // may be null for unassigned personal tasks (SQL supports)
    year, quarter,
    title,
    tags,
    due_date: due_date,
    created_by: sessionUser.id,
    owner_user_id: ownerUserId,
    primary_user_id: t.primary_user_id
  }));

  const { error: insErr } = await db("compliance_tasks").insert(rows);
  if(insErr){ console.error(insErr); return toast(insErr.message); }

  els.taskTitle.value = "";
  els.taskTags.value = "";
  els.taskDueDate.value = "";
  els.taskDueMode.value = "quarter";
  updateTaskDueModeUI();
  toast(`Task(s) created: ${rows.length}`);
  await refresh();
}


function renderSnapshot(){
  const year = Number(els.yearSel.value);
  const q = Number(els.qSel.value);
  const teamId = els.teamSel.value;

  let list = tasks.slice();
  if(teamId !== "all") list = list.filter(t=> t.team_id===teamId);

  if(roleIs("rcm")){
    const myTeamIds = teams.filter(t=> t.rcm_user_id === sessionUser.id).map(t=> t.id);
    list = list.filter(t=> myTeamIds.includes(t.team_id));
  }

  const total = list.length;
  const done = list.filter(t=> isTaskCompleted(t.id)).length;
  const open = total - done;

  els.snapshotText.innerHTML = `
    <div>Period: <b>${year} Q${q}</b></div>
    <div>Tasks: <b>${total}</b> | Open: <b>${open}</b> | Completed: <b>${done}</b></div>
    <div class="muted" style="margin-top:6px;">
      Scope: <b>${teamId==="all" ? "All teams" : teamName(teamId)}</b>
    </div>
  `;
}

async function refresh(){
  await loadCore();
  buildSelectors();
renderSnapshot();
  await renderTasks();
  await renderBriefs();
  await renderProjects();
  await renderPeople();
  await renderTeams();
  await renderAdminTasks();
}

function startAutoRefresh(){
  stopAutoRefresh();
  refreshTimer = setInterval(async ()=>{
    // avoid hammering when not visible
    if(document.hidden) return;
    await refresh();
  }, 10000);
}
function stopAutoRefresh(){
  if(refreshTimer){ clearInterval(refreshTimer); refreshTimer = null; }
}

async function boot(){
  const { data: sess } = await sb.auth.getSession();
  sessionUser = sess?.session?.user || null;

  if(!sessionUser){
    stopAutoRefresh();
    els.app.classList.add("hide");
    els.authCard.classList.remove("hide");
    els.signOut.style.display = "none";
    els.userPill.textContent = "Not signed in";
    return;
  }

  if(!(await ensureSchemaExposed())) return;

  profile = await ensureProfile();
  if(!profile){
    // keep them on auth card so they don’t smash random buttons and blame you.
    stopAutoRefresh();
    els.app.classList.add("hide");
    els.authCard.classList.remove("hide");
    return;
  }

  els.authCard.classList.add("hide");
  els.app.classList.remove("hide");
  els.signOut.style.display = "";
  els.userPill.textContent = `${profile.display_name || sessionUser.email} (${profile.role})`;

  enforceRoleUI();
  initYearQuarter();
await refresh();
  setTab("compliance");
  startAutoRefresh();
}

function wireUI(){
  els.signIn.addEventListener("click", (e)=>{ e.preventDefault(); signIn(); });
  els.magic.onclick = sendMagicLink;
  els.signOut.addEventListener("click", (e)=>{ e.preventDefault(); signOut(); });
els.yearSel.onchange = refresh;
  els.qSel.onchange = refresh;
  els.teamSel.onchange = async ()=>{
    await rebuildStaffSelector();
    await refresh();
  };
  els.staffSel.onchange = renderTasks;
  els.searchBox.oninput = async ()=>{
    await renderTasks();
    await renderBriefs();
  };

  els.tabs.onclick = (e)=>{
    const tab = e.target?.dataset?.tab;
    if(tab) setTab(tab);
  };

  els.uploadBriefBtn.onclick = uploadBrief;
  els.createTaskBtn.onclick = createTask;

  if(els.taskDueMode) els.taskDueMode.onchange = updateTaskDueModeUI;
  els.createTeamBtn.onclick = createTeam;
  if(els.reloadPeopleBtn) els.reloadPeopleBtn.onclick = refresh;
  if(els.createUserBtn) els.createUserBtn.onclick = createAuthUser;
  els.addProjBtn.onclick = addProject;
  if(els.taskTargetType) els.taskTargetType.onchange = syncAdminTargetVisibility;
}

wireUI();
boot();

if(sb){
  sb.auth.onAuthStateChange((_event,_session)=> { boot(); });
}
</script>
</body>
</html>

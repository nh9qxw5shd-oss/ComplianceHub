<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Control Operational Compliance Keeper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --header:#111827; --headerText:#f9fafb; --border:#e5e7eb;
      --shadow:0 6px 18px rgba(0,0,0,.08); --radius:14px;
      --btn:#111827; --btnText:#f9fafb; --btn2:#ffffff; --btn2Text:#111827;
      --focus:rgba(17,24,39,.15);
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);margin:0;color:var(--text)}
    header{background:var(--header);color:var(--headerText);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;gap:1rem;position:sticky;top:0;z-index:10}
    header h1{font-size:1.05rem;margin:0;letter-spacing:.2px}
    header .env{font-size:.8rem;opacity:.8}
    header .right{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    main{padding:1.25rem;max-width:1240px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1.4fr .6fr;gap:1rem}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem}
    .card h2{margin:.1rem 0 .75rem;font-size:1rem}
    .muted{color:var(--muted)} .mini{font-size:.82rem}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    .tabs{display:flex;gap:.4rem;flex-wrap:wrap}
    .tab{border:1px solid rgba(249,250,251,.25);background:rgba(249,250,251,.08);color:var(--headerText);padding:.45rem .7rem;border-radius:999px;cursor:pointer;font-size:.85rem;user-select:none}
    .tab.active{background:rgba(249,250,251,.22);border-color:rgba(249,250,251,.35)}
    button{border:1px solid var(--border);background:var(--btn);color:var(--btnText);padding:.5rem .75rem;border-radius:10px;cursor:pointer;font-weight:600;font-size:.85rem}
    button.ghost{background:var(--btn2);color:var(--btn2Text)}
    button:focus{outline:3px solid var(--focus);outline-offset:2px}
    input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem;font-size:.9rem;background:#fff;min-height:38px}
    textarea{min-height:84px;width:100%}
    label{font-size:.8rem;color:var(--muted)}
    .field{display:flex;flex-direction:column;gap:.25rem}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:.55rem .5rem;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.78rem;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);text-align:left}
    tr:hover td{background:#fafafa}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .55rem;border-radius:999px;border:1px solid var(--border);background:#fafafa;font-size:.78rem;color:var(--text);white-space:nowrap}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.green{background:#16a34a}.dot.amber{background:#f59e0b}.dot.red{background:#dc2626}.dot.grey{background:#9ca3af}
    .hide{display:none!important}
    .hr{height:1px;background:var(--border);margin:.9rem 0}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem}
    @media (max-width:980px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .box{border:1px solid var(--border);border-radius:12px;padding:.7rem;background:#fff}
    .kpi .big{font-size:1.2rem;font-weight:800}
    .kpi .small{font-size:.78rem;color:var(--muted)}
    .toast{position:fixed;right:18px;bottom:18px;max-width:460px;background:#111827;color:#f9fafb;padding:.75rem .9rem;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.2);display:none;z-index:50}
    .toast.show{display:block}
    .subtle{background:#f9fafb;border:1px dashed var(--border);padding:.75rem;border-radius:12px}
    a{color:#111827}
  </style>
</head>
<body>
<header>
  <div>
    <h1>Control Operational Compliance Keeper</h1>
    <div class="env" id="envLine">GitHub Hosted UI · Supabase Backend (baked-in config)</div>
  </div>
  <div class="right">
    <div class="tabs">
      <div class="tab active" data-tab="tasks">Tasks</div>
      <div class="tab" data-tab="briefs">Briefing Hub</div>
      <div class="tab" data-tab="projects">Projects</div>
      <div class="tab" data-tab="teams" id="teamsTab">Teams</div>
    </div>
    <button class="ghost" id="controllerBtn" title="Read-only access, except acknowledging briefs and recording completion where enabled">Controller access</button>
    <button class="ghost" id="loginBtn">Login</button>
    <button class="ghost hide" id="logoutBtn">Logout</button>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="row space">
        <div>
          <h2 id="panelTitle">Tasks</h2>
          <div class="muted mini" id="panelSub">Default view shows all relevant items. Filters are secondary. No auto-refresh loops (manual refresh only).</div>
        </div>
        <div class="row">
          <span class="pill" id="whoAmI"><span class="dot grey"></span><span class="mini">Not connected</span></span>
          <button class="hide" id="createBtn">Create</button>
        </div>
      </div>

      <div id="tab_tasks">
        <div class="kpi" id="taskKpis">
          <div class="box"><div class="big" id="kpiDue">0</div><div class="small">Open tasks</div></div>
          <div class="box"><div class="big" id="kpiRed">0</div><div class="small">Red</div></div>
          <div class="box"><div class="big" id="kpiAmber">0</div><div class="small">Amber</div></div>
          <div class="box"><div class="big" id="kpiGreen">0</div><div class="small">Green</div></div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="field" style="min-width:220px">
            <label>Filter: Team</label>
            <select id="filterTeam"><option value="">All</option></select>
          </div>
          <div class="field" style="min-width:220px">
            <label>Filter: Staff</label>
            <select id="filterStaff"><option value="">All</option></select>
          </div>
          <div class="field" style="min-width:220px">
            <label>Filter: Status</label>
            <select id="filterStatus">
              <option value="">All</option>
              <option value="open">Open</option>
              <option value="complete">Complete</option>
            </select>
          </div>
          <div class="field" style="min-width:220px">
            <label>Search</label>
            <input id="searchBox" placeholder="Title / description" />
          </div>
          <div style="margin-left:auto" class="row">
            <button class="ghost" id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div class="hr"></div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:64px">RAG</th>
                <th>Task</th>
                <th style="width:140px">Due</th>
                <th style="width:160px">Target</th>
                <th style="width:160px">Owner</th>
                <th style="width:170px">Actions</th>
              </tr>
            </thead>
            <tbody id="taskTbody"></tbody>
          </table>
        </div>
      </div>

      <div id="tab_briefs" class="hide">
        <div class="subtle mini">
          Briefs can be uploaded by SNDM. Anyone can record “Read & understood” by selecting a name from the staff pool.
        </div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:220px">Title</th>
                <th>Description</th>
                <th style="width:160px">Published</th>
                <th style="width:220px">Read & understood</th>
              </tr>
            </thead>
            <tbody id="briefTbody"></tbody>
          </table>
        </div>
      </div>

      <div id="tab_projects" class="hide">
        <div class="subtle mini">
          Projects are non-compliance work, tracked for visibility. SNDM manages creation/status. Notes are append-only.
        </div>
        <div class="hr"></div>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:220px">Project</th>
                <th>Description</th>
                <th style="width:130px">Status</th>
                <th style="width:180px">Owner</th>
                <th style="width:170px">Actions</th>
              </tr>
            </thead>
            <tbody id="projTbody"></tbody>
          </table>
        </div>
      </div>

      <div id="tab_teams" class="hide">
        <div class="subtle mini">
          Teams are operational groupings used for targeting/filtering. Only SNDM can manage team setup and membership.
        </div>
        <div class="hr"></div>
        <div id="teamsArea" class="mini muted">Login as SNDM to manage teams.</div>
      </div>
    </section>

    <aside class="card">
      <h2>Actions</h2>

      <div id="connCard" class="subtle hide">
        <div class="mini muted">Supabase connection</div>
        <div class="hr"></div>
        <div class="field">
          <label>Supabase URL</label>
          <input id="sbUrl" placeholder="https://xxxxx.sb.co" />
        </div>
        <div class="field">
          <label>Anon key (public)</label>
          <input id="sbAnon" placeholder="eyJhbGciOi..." />
        </div>
        <div class="row" style="margin-top:.6rem">
          <button id="saveConn">Save</button>
          <button class="ghost" id="clearConn">Clear</button>
        </div>
        <div class="mini muted" style="margin-top:.6rem">
          Saved in localStorage. Don’t paste a service role key into a public website unless you like free penetration testing.
        </div>
      </div>

      <div class="hr"></div>

      <div id="loginCard" class="hide">
        <div class="mini muted">SNDM / RCM login</div>
        <div class="hr"></div>
        <div class="field">
          <label>Email</label>
          <input id="email" type="email" placeholder="name@domain" />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="pass" type="password" placeholder="••••••••" />
        </div>
        <div class="row" style="margin-top:.6rem">
          <button id="doLogin">Login</button>
        </div>
      </div>

      <div id="controllerCard" class="hide">
        <div class="mini muted">Controller access (no login)</div>
        <div class="hr"></div>
        <div class="field">
          <label>Select your name</label>
          <select id="controllerStaff"><option value="">Select…</option></select>
        </div>
        <div class="row" style="margin-top:.6rem">
          <button id="enterController">Enter</button>
          <button class="ghost" id="exitController">Exit</button>
        </div>
        <div class="mini muted" style="margin-top:.6rem">
          Controller mode is read-only visibility, plus “Read & understood” acknowledgements.
        </div>
      </div>

      <div class="hr"></div>

      <div id="detailCard" class="subtle">
        <div class="mini muted" id="detailTitle">Select an item</div>
        <div class="hr"></div>
        <div id="detailBody" class="mini muted">Notes and actions will appear here.</div>
      </div>
    </aside>
  </div>
</main>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));
  const fmtDate = (iso)=> iso ? new Date(iso).toLocaleDateString(undefined,{year:"numeric",month:"short",day:"2-digit"}) : "";
  const daysUntil = (iso)=> iso ? Math.ceil((new Date(iso).getTime()-Date.now())/86400000) : null;
  const toast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2600); };
  const escapeHtml = (s)=> (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const rag = (task, complete)=>{
    if(complete) return "green";
    if(!task.due_at) return "grey";
    const d=daysUntil(task.due_at);
    if(d<=0) return "red";
    if(d<=7) return "amber";
    return "green";
  };

  let sb=null;
  let me={ mode:"none", role:null, staff_id:null, staff_name:null, user_id:null, display_name:null };
  let cache={ staff:[], teams:[], tasks:[], taskNotes:[], taskCompletions:[], briefs:[], briefAck:[], projects:[], projectNotes:[] };

    // ===== Supabase config (baked in) =====
  // Put these in ONE place and stop pasting keys into UI fields like it's 2009.
  const SUPABASE_URL = "https://ungtmfwxqawkdiflmora.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuZ3RtZnd4cWF3a2RpZmxtb3JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDY4NjQsImV4cCI6MjA3NzY4Mjg2NH0.Yaq0XfbbkwxJDUoiPCS7bLVBy70Wa-NOOWIxkpRRxdc";

  function initSupabase(){
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("YOURPROJECT") || SUPABASE_ANON_KEY.includes("YOUR_")){
      $("#whoAmI").innerHTML = `<span class="dot red"></span><span class="mini">Supabase not configured</span>`;
      toast("Set SUPABASE_URL + SUPABASE_ANON_KEY in the HTML");
      return null;
    }
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    $("#whoAmI").innerHTML = `<span class="dot grey"></span><span class="mini">Connected</span>`;
    return client;
  }


  async function hydrateProfile(){
    const { data, error } = await sb.from("cck.profiles").select("display_name,role").eq("user_id",me.user_id).single();
    if(error){ me.role=null; me.display_name=null; return; }
    me.role=data.role; me.display_name=data.display_name;
  }

  async function doLogin(){
    if(!sb) return toast("Connect to Supabase first");
    const email=$("#email").value.trim(), password=$("#pass").value;
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) return toast(error.message);
    me.mode="auth"; me.user_id=data.user.id;
    await hydrateProfile(); await boot(); toast("Logged in");
  }
  async function doLogout(){
    if(!sb) return;
    await sb.auth.signOut();
    me={ mode:"none", role:null, staff_id:null, staff_name:null, user_id:null, display_name:null };
    $("#logoutBtn").classList.add("hide"); $("#loginBtn").classList.remove("hide");
    $("#loginCard").classList.add("hide"); $("#controllerCard").classList.add("hide");
    $("#createBtn").classList.add("hide");
    $("#whoAmI").innerHTML=`<span class="dot grey"></span><span class="mini">Connected (anon)</span>`;
    toast("Logged out"); await boot();
  }

  async function loadStaffTeams(){
    const { data: staff } = await sb.from("cck.staff_pool").select("id,display_name").order("display_name");
    const { data: teams } = await sb.from("cck.teams").select("id,name").order("name");
    cache.staff=staff||[]; cache.teams=teams||[];
  }
  async function loadTasks(){
    const { data: tasks } = await sb.from("cck.tasks")
      .select("id,title,description,task_type,due_at,target_team_id,target_staff_id,owner_staff_id,linked_brief_id,created_at")
      .order("due_at",{ascending:true,nullsFirst:false});
    cache.tasks=tasks||[];
    const ids=cache.tasks.map(t=>t.id);
    if(!ids.length){ cache.taskNotes=[]; cache.taskCompletions=[]; return; }
    const { data: notes } = await sb.from("cck.task_notes").select("id,task_id,author_user_id,author_staff_id,note,created_at").in("task_id",ids).order("created_at",{ascending:false});
    const { data: comps } = await sb.from("cck.task_completions").select("id,task_id,completed,completed_at").in("task_id",ids).order("completed_at",{ascending:false});
    cache.taskNotes=notes||[]; cache.taskCompletions=comps||[];
  }
  async function loadBriefs(){
    const { data: briefs } = await sb.from("cck.briefs").select("id,title,description,file_path,created_at").order("created_at",{ascending:false});
    cache.briefs=briefs||[];
    const ids=cache.briefs.map(b=>b.id);
    if(!ids.length){ cache.briefAck=[]; return; }
    const { data: ack } = await sb.from("cck.brief_ack").select("id,brief_id,staff_id,ack_at").in("brief_id",ids);
    cache.briefAck=ack||[];
  }
  async function loadProjects(){
    const { data: projs } = await sb.from("cck.projects").select("id,title,description,status,owner_staff_id,updated_at").order("updated_at",{ascending:false});
    cache.projects=projs||[];
    const ids=cache.projects.map(p=>p.id);
    if(!ids.length){ cache.projectNotes=[]; return; }
    const { data: notes } = await sb.from("cck.project_notes").select("id,project_id,note,created_at").in("project_id",ids).order("created_at",{ascending:false});
    cache.projectNotes=notes||[];
  }

  const nameForStaff=(id)=> (cache.staff.find(s=>s.id===id)||{}).display_name||"";
  const nameForTeam=(id)=> (cache.teams.find(t=>t.id===id)||{}).name||"";
  const isTaskComplete=(task_id)=> !!(cache.taskCompletions.find(c=>c.task_id===task_id && c.completed));

  function renderFilters(){
    const ft=$("#filterTeam"), fs=$("#filterStaff"), cs=$("#controllerStaff");
    const t0=ft.value, s0=fs.value, c0=cs.value;
    ft.innerHTML=`<option value="">All</option>`+cache.teams.map(t=>`<option value="${t.id}">${t.name}</option>`).join("");
    fs.innerHTML=`<option value="">All</option>`+cache.staff.map(s=>`<option value="${s.id}">${s.display_name}</option>`).join("");
    cs.innerHTML=`<option value="">Select…</option>`+cache.staff.map(s=>`<option value="${s.id}">${s.display_name}</option>`).join("");
    ft.value=t0; fs.value=s0; cs.value=c0;
  }

  function renderTaskKpis(rows){
    const open=rows.filter(r=>!r.complete);
    $("#kpiDue").textContent=open.length;
    $("#kpiRed").textContent=open.filter(r=>r.rag==="red").length;
    $("#kpiAmber").textContent=open.filter(r=>r.rag==="amber").length;
    $("#kpiGreen").textContent=open.filter(r=>r.rag==="green").length;
  }

  function renderTasks(){
    const ft=$("#filterTeam").value, fs=$("#filterStaff").value, st=$("#filterStatus").value, q=$("#searchBox").value.trim().toLowerCase();
    const rows=cache.tasks.map(t=>({t, complete:isTaskComplete(t.id)})).map(r=>({...r, rag:rag(r.t,r.complete)})).filter(r=>{
      if(ft && r.t.target_team_id!==ft) return false;
      if(fs && r.t.target_staff_id!==fs && r.t.owner_staff_id!==fs) return false;
      if(st==="open" && r.complete) return false;
      if(st==="complete" && !r.complete) return false;
      if(q && !(`${r.t.title||""} ${r.t.description||""}`.toLowerCase().includes(q))) return false;
      return true;
    });
    renderTaskKpis(rows);
    $("#taskTbody").innerHTML=rows.map(r=>{
      const due=r.t.due_at?fmtDate(r.t.due_at):"";
      const target=r.t.target_team_id?`Team: ${nameForTeam(r.t.target_team_id)}`:r.t.target_staff_id?`Staff: ${nameForStaff(r.t.target_staff_id)}`:"All";
      const owner=nameForStaff(r.t.owner_staff_id)||"";
      const pill=`<span class="pill"><span class="dot ${r.rag}"></span><span>${r.rag.toUpperCase()}</span></span>`;
      const canAct=(me.mode==="auth" || (me.mode==="controller" && me.staff_id));
      const act=r.complete?`<span class="muted mini">Completed</span>`:canAct?`<button class="ghost mini" data-action="complete" data-id="${r.t.id}">Mark complete</button>`:`<span class="muted mini">Login to action</span>`;
      return `<tr data-open="${r.t.id}">
        <td>${pill}</td>
        <td><div style="font-weight:750">${escapeHtml(r.t.title||"")}</div><div class="muted mini">${escapeHtml(r.t.description||"")}</div></td>
        <td>${due}</td><td>${escapeHtml(target)}</td><td>${escapeHtml(owner)}</td><td>${act}</td>
      </tr>`;
    }).join("");
    $$("#taskTbody button[data-action='complete']").forEach(b=>b.addEventListener("click", async (e)=>{ e.stopPropagation(); await markTaskComplete(b.dataset.id); }));
    $$("#taskTbody tr").forEach(tr=>tr.addEventListener("click",(e)=>{ if(e.target?.dataset?.action) return; openTaskDetail(tr.dataset.open); }));
  }

  function renderBriefs(){
    $("#briefTbody").innerHTML=cache.briefs.map(b=>{
      const created=fmtDate(b.created_at);
      const acks=cache.briefAck.filter(a=>a.brief_id===b.id).map(a=>nameForStaff(a.staff_id)).filter(Boolean);
      const ackLine=acks.length?`<div class="mini">${acks.slice(0,5).join(", ")}${acks.length>5?"…":""}</div>`:`<div class="mini muted">No acks yet</div>`;
      const canAck=(me.mode==="controller" && me.staff_id);
      const ackBtn=canAck?`<button class="ghost mini" data-ack="${b.id}">Acknowledge</button>`:`<span class="muted mini">Use controller access</span>`;
      const link=b.file_path?`<a href="#" data-openbrief="${b.id}">Open</a>`:"";
      return `<tr>
        <td><div style="font-weight:750">${escapeHtml(b.title||"")}</div><div class="mini">${link}</div></td>
        <td class="mini">${escapeHtml(b.description||"")}</td>
        <td class="mini">${created}</td>
        <td>${ackLine}<div style="margin-top:.35rem">${ackBtn}</div></td>
      </tr>`;
    }).join("");
    $$("#briefTbody button[data-ack]").forEach(btn=>btn.addEventListener("click", async ()=>{ await acknowledgeBrief(btn.dataset.ack); }));
    $$("#briefTbody a[data-openbrief]").forEach(a=>a.addEventListener("click", async (e)=>{ e.preventDefault(); await openBriefFile(a.dataset.openbrief); }));
  }

  function renderProjects(){
    $("#projTbody").innerHTML=cache.projects.map(p=>{
      const owner=nameForStaff(p.owner_staff_id);
      const canNote=(me.mode==="auth" || (me.mode==="controller" && me.staff_id));
      const act=canNote?`<button class="ghost mini" data-pnote="${p.id}">Add note</button>`:`<span class="muted mini">Login / controller access</span>`;
      return `<tr data-proj="${p.id}">
        <td><div style="font-weight:750">${escapeHtml(p.title||"")}</div></td>
        <td class="mini">${escapeHtml(p.description||"")}</td>
        <td><span class="pill"><span class="dot grey"></span><span>${escapeHtml(p.status||"")}</span></span></td>
        <td class="mini">${escapeHtml(owner)}</td>
        <td>${act}</td>
      </tr>`;
    }).join("");
    $$("#projTbody button[data-pnote]").forEach(btn=>btn.addEventListener("click", async (e)=>{ e.stopPropagation(); await addProjectNote(btn.dataset.pnote); }));
  }

  function applyRole(){
    // Blueprint: Teams managed by SNDM only; RCM can’t see/edit team setup.
    if(me.mode==="auth" && me.role==="sndm") $("#teamsTab").classList.remove("hide");
    else $("#teamsTab").classList.add("hide");

    if(me.mode==="auth"){
      const dot=me.role==="sndm"?"green":"amber";
      $("#whoAmI").innerHTML=`<span class="dot ${dot}"></span><span class="mini">${escapeHtml(me.display_name||"User")} (${me.role||"auth"})</span>`;
      $("#logoutBtn").classList.remove("hide"); $("#loginBtn").classList.add("hide");
    } else if(me.mode==="controller"){
      $("#whoAmI").innerHTML=`<span class="dot grey"></span><span class="mini">${escapeHtml(me.staff_name||"Controller")} (controller)</span>`;
      $("#logoutBtn").classList.add("hide"); $("#loginBtn").classList.remove("hide");
    } else {
      $("#whoAmI").innerHTML=`<span class="dot grey"></span><span class="mini">Connected (anon)</span>`;
      $("#logoutBtn").classList.add("hide"); $("#loginBtn").classList.remove("hide");
    }
  }

  function setTab(tab){
    $$(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===tab));
    $("#tab_tasks").classList.toggle("hide",tab!=="tasks");
    $("#tab_briefs").classList.toggle("hide",tab!=="briefs");
    $("#tab_projects").classList.toggle("hide",tab!=="projects");
    $("#tab_teams").classList.toggle("hide",tab!=="teams");
    $("#panelTitle").textContent={tasks:"Tasks",briefs:"Briefing Hub",projects:"Projects",teams:"Teams"}[tab]||"Dashboard";
  }

  async function markTaskComplete(task_id){
    const payload = me.mode==="auth"
      ? { task_id, completed:true, completed_by_user_id: me.user_id }
      : { task_id, completed:true, completed_by_staff_id: me.staff_id };
    const { error } = await sb.from("cck.task_completions").insert(payload);
    if(error) return toast(error.message);
    await loadTasks(); renderTasks(); toast("Marked complete");
  }

  async function acknowledgeBrief(brief_id){
    if(me.mode!=="controller" || !me.staff_id) return toast("Enter controller mode and pick your name");
    const { error } = await sb.from("cck.brief_ack").insert({ brief_id, staff_id: me.staff_id });
    if(error) return toast(error.message);
    await loadBriefs(); renderBriefs(); toast("Acknowledged");
  }

  function getPublicStorageUrl(file_path){
    const base=SUPABASE_URL;
    if(!base || !file_path) return null;
    let obj=file_path.startsWith("briefs/")?file_path.slice(7):file_path;
    return `${base}/storage/v1/object/public/briefs/${encodeURIComponent(obj).replaceAll("%2F","/")}`;
  }
  async function openBriefFile(brief_id){
    const b=cache.briefs.find(x=>x.id===brief_id); if(!b) return;
    const url=getPublicStorageUrl(b.file_path);
    if(!url) return toast("No file path / storage URL");
    window.open(url,"_blank");
  }

  async function addProjectNote(project_id){
    const note=prompt("Add project note (keep it short):"); if(!note?.trim()) return;
    const payload = me.mode==="auth"
      ? { project_id, note: note.trim(), author_user_id: me.user_id }
      : { project_id, note: note.trim(), author_staff_id: me.staff_id };
    const { error } = await sb.from("cck.project_notes").insert(payload);
    if(error) return toast(error.message);
    await loadProjects(); renderProjects(); toast("Note added");
  }

  function openTaskDetail(task_id){
    const t=cache.tasks.find(x=>x.id===task_id); if(!t) return;
    const complete=isTaskComplete(task_id);
    const target=t.target_team_id?`Team: ${nameForTeam(t.target_team_id)}`:t.target_staff_id?`Staff: ${nameForStaff(t.target_staff_id)}`:"All";
    const owner=nameForStaff(t.owner_staff_id)||"—";
    const due=t.due_at?fmtDate(t.due_at):"—";
    const ragc=rag(t,complete);
    $("#detailTitle").textContent=`Task: ${t.title}`;
    $("#detailBody").innerHTML=`<div class="row" style="justify-content:space-between;margin-bottom:.4rem">
        <span class="pill"><span class="dot ${ragc}"></span><span>${ragc.toUpperCase()}</span></span>
        <span class="mini muted">${complete?"Completed":"Open"}</span>
      </div>
      <div class="mini"><b>Due:</b> ${escapeHtml(due)} · <b>Target:</b> ${escapeHtml(target)} · <b>Owner:</b> ${escapeHtml(owner)}</div>`;
  }

  async function boot(){
    if(!sb) return;
    const { data: sess } = await sb.auth.getSession();
    if(sess?.session?.user){
      me.mode="auth"; me.user_id=sess.session.user.id;
      await hydrateProfile();
    } else if(me.mode!=="controller"){
      me.mode="none"; me.user_id=null; me.role=null; me.display_name=null;
    }
    applyRole();

    await loadStaffTeams(); renderFilters();
    await Promise.all([loadTasks(), loadBriefs(), loadProjects()]);
    renderTasks(); renderBriefs(); renderProjects();
  }

  // Wiring
  $$(".tab").forEach(t=>t.addEventListener("click",()=>setTab(t.dataset.tab)));
  
  $("#loginBtn").addEventListener("click",()=>{ $("#loginCard").classList.toggle("hide"); $("#controllerCard").classList.add("hide"); });
  $("#controllerBtn").addEventListener("click",()=>{ $("#controllerCard").classList.toggle("hide"); $("#loginCard").classList.add("hide"); });

  $("#doLogin").addEventListener("click",doLogin);
  $("#logoutBtn").addEventListener("click",doLogout);

  $("#enterController").addEventListener("click",async ()=>{
    const staff_id=$("#controllerStaff").value;
    const staff=cache.staff.find(s=>s.id===staff_id);
    if(!staff_id||!staff) return toast("Pick your name");
    me.mode="controller"; me.role="controller"; me.staff_id=staff_id; me.staff_name=staff.display_name;
    applyRole(); toast("Controller mode enabled"); await boot();
  });
  $("#exitController").addEventListener("click",()=>{ me.mode="none"; me.role=null; me.staff_id=null; me.staff_name=null; applyRole(); boot(); });

  $("#refreshBtn").addEventListener("click",async ()=>{ await boot(); toast("Refreshed"); });

  // Per blueprint: NO auto-refresh loops.
  sb = initSupabase();
  if(sb) boot();
</script>
</body>
</html>

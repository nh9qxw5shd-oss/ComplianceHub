<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CCK Compliance Admin</title>
<style>

:root{
      --bg:#f3f4f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
      --header:#111827; --headerText:#f9fafb; --border:#e5e7eb;
      --shadow:0 6px 18px rgba(0,0,0,.08); --radius:14px;
      --btn:#111827; --btnText:#f9fafb; --btn2:#ffffff; --btn2Text:#111827;
      --focus:rgba(17,24,39,.15);
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);margin:0;color:var(--text)}
    header{background:var(--header);color:var(--headerText);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;gap:1rem;position:sticky;top:0;z-index:10}
    header h1{font-size:1.05rem;margin:0;letter-spacing:.2px}
    header .env{font-size:.8rem;opacity:.8}
    header .right{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    main{padding:1.25rem;max-width:1240px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1.4fr .6fr;gap:1rem}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem}
    .card h2{margin:.1rem 0 .75rem;font-size:1rem}
    .muted{color:var(--muted)} .mini{font-size:.82rem}
    .row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    .tabs{display:flex;gap:.4rem;flex-wrap:wrap}
    .tab{border:1px solid rgba(249,250,251,.25);background:rgba(249,250,251,.08);color:var(--headerText);padding:.45rem .7rem;border-radius:999px;cursor:pointer;font-size:.85rem;user-select:none}
    .tab.active{background:rgba(249,250,251,.22);border-color:rgba(249,250,251,.35)}
    button{border:1px solid var(--border);background:var(--btn);color:var(--btnText);padding:.5rem .75rem;border-radius:10px;cursor:pointer;font-weight:600;font-size:.85rem}
    button.ghost{background:var(--btn2);color:var(--btn2Text)}
    button:focus{outline:3px solid var(--focus);outline-offset:2px}
    button:disabled{opacity:.45;cursor:not-allowed}
    .sm{padding:.35rem .55rem;font-size:.82rem;border-radius:9px}
    input,select,textarea{border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem;font-size:.9rem;background:#fff;min-height:38px}
    textarea{min-height:84px;width:100%}
    label{font-size:.8rem;color:var(--muted)}
    .field{display:flex;flex-direction:column;gap:.25rem}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    th,td{padding:.55rem .5rem;border-bottom:1px solid var(--border);vertical-align:top}
    th{font-size:.78rem;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);text-align:left}
    tr:hover td{background:#fafafa}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .55rem;border-radius:999px;border:1px solid var(--border);background:#fafafa;font-size:.78rem;color:var(--text);white-space:nowrap}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.green{background:#16a34a}.dot.amber{background:#f59e0b}.dot.red{background:#dc2626}.dot.grey{background:#9ca3af}
    .hide{display:none!important}
    .hr{height:1px;background:var(--border);margin:.9rem 0}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem}
    @media (max-width:980px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .box{border:1px solid var(--border);border-radius:12px;padding:.7rem;background:#fff}
    .kpi .big{font-size:1.2rem;font-weight:800}
    .kpi .small{font-size:.78rem;color:var(--muted)}
    .toast{position:fixed;right:18px;bottom:18px;max-width:460px;background:#111827;color:#f9fafb;padding:.75rem .9rem;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.2);display:none;z-index:50}
    .toast.show{display:block}
    .subtle{background:#f9fafb;border:1px dashed var(--border);padding:.75rem;border-radius:12px}
    a{color:#111827}
  
    .cols{
      display:grid;
      grid-template-columns: 2.2fr 1fr;
      gap: 1.25rem;
      align-items:start;
    }
    @media (max-width: 980px){
      .cols{ grid-template-columns: 1fr; }
    }
  

/* Bolt-on pages tweaks */
main{max-width:1200px;margin:0 auto;padding:1.25rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:1rem}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media (max-width: 980px){.grid2{grid-template-columns:1fr}}
.tableWrap{overflow:auto;border:1px solid var(--line);border-radius:14px;background:var(--card)}
table{width:100%;border-collapse:collapse}
th,td{padding:.65rem .75rem;border-bottom:1px solid var(--line);vertical-align:top}
th{text-align:left;font-size:.82rem;letter-spacing:.02em;color:var(--muted);background:linear-gradient(to bottom, rgba(17,24,39,.04), rgba(17,24,39,0));position:sticky;top:0}
tr:hover td{background:rgba(17,24,39,.03)}
.pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border:1px solid var(--line);border-radius:999px;font-size:.8rem}
.pill.ok{background:rgba(16,185,129,.10)}
.pill.warn{background:rgba(245,158,11,.12)}
.pill.bad{background:rgba(239,68,68,.10)}
.pill.off{background:rgba(107,114,128,.12)}
.small{font-size:.85rem;color:var(--muted)}

/* === Main-body tabs (visible on light background) === */
.mainTabs .tab{
  color: var(--text);
  background: #ffffff;
  border: 1px solid var(--border);
}
.mainTabs .tab.active{
  background: var(--header);
  color: var(--headerText);
  border-color: rgba(17,24,39,.35);
}

</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <div class="row" style="gap:.75rem">
    <div style="font-weight:800">Control Operational Compliance Keeper</div>
    <div class="mini muted">Tasks</div>
  </div>

  <div class="row">
    <div id="whoAmI" class="who mini">
      <span class="dot grey"></span>
      <span class="statusText">Not connected</span>
      <span id="whoLabel" style="margin-left:.5rem" class="muted"></span>
    </div>
          <button class="ghost sm" type="button" onclick="location.href='index.html'">
    ← Back to Tasks
  </button>
    <button class="btn" id="loginBtnTop">SNDM Login</button>
    <button class="btn ghost hide" id="logoutBtnTop">Logout</button>
    <button class="btn hide" id="createBtnTop">Create Task</button>
  </div>
</header>
<main>
<!-- Tabs -->
<div class="row mainTabs" style="gap:.5rem; flex-wrap:wrap; margin-bottom:1rem">
  <button class="tab active" id="tabPortfolios" type="button">Portfolios</button>
  <button class="tab" id="tabStaff" type="button">Staff Manager</button>
  <button class="tab" id="tabCatalog" type="button">Catalog Manager</button>
</div>

<!-- === Portfolios (existing) === -->
<div id="viewPortfolios">
  <div class="grid2">
    <section class="card">
      <h2 style="margin:.1rem 0 .6rem 0">Compliance Admin</h2>
      <div class="small">Build portfolios safely. Automation is per-person and defaults OFF.</div>

      <div class="row" style="margin-top:.9rem; gap:.6rem; flex-wrap:wrap">
        <label style="min-width:260px">
          <div class="mini muted">Person</div>
          <select id="personSel"></select>
        </label>

        <label style="min-width:240px">
          <div class="mini muted">Default owner (optional)</div>
          <select id="ownerSel"></select>
        </label>

        <label style="min-width:240px">
          <div class="mini muted">Default owner team (optional)</div>
          <select id="ownerTeamSel"></select>
        </label>

        <label style="min-width:180px">
          <div class="mini muted">Default horizon (days)</div>
          <input id="horizonInp" class="input" type="number" min="1" placeholder="(blank = 60)" />
        </label>

        <label style="min-width:180px">
          <div class="mini muted">Automation</div>
          <div class="row" style="gap:.5rem">
            <input id="autoToggle" type="checkbox" style="width:18px;height:18px"/>
            <span id="autoLabel" class="pill off">OFF</span>
          </div>
        </label>

        <button class="btn" id="saveSettingsBtn" style="align-self:end">Save settings</button>
      </div>

      <div class="small" style="margin-top:.75rem">
        Tip: assign items first, set last-completed dates, then enable automation when ready.
      </div>
    </section>

    <section class="card">
      <h2 style="margin:.1rem 0 .6rem 0">Assignment Builder</h2>
      <div class="small">Tick what applies. Enter last completed to calculate expiry. Manual items can use an explicit next expiry date.</div>

      <div class="row" style="margin-top:.9rem; gap:.6rem; flex-wrap:wrap">
        <input id="filterInp" class="input" placeholder="Filter items..." style="flex:1; min-width:240px"/>
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:1rem">
    <h2 style="margin:.1rem 0 .6rem 0">Items for selected person</h2>
    <div class="tableWrap">
      <table id="itemsTbl">
        <thead>
          <tr>
            <th style="width:52px">Use</th>
            <th>Item</th>
            <th style="width:120px">Mode</th>
            <th style="width:140px">Last done</th>
            <th style="width:160px">Expiry</th>
            <th style="width:120px">Horizon</th>
            <th style="width:120px">Status</th>
            <th style="width:220px">Overrides</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<!-- === Staff Manager === -->
<div id="viewStaff" class="hide">
  <section class="card">
    <div class="row space">
      <h2 style="margin:.1rem 0 .6rem 0">Staff Manager</h2>
      <button class="btn ghost" id="staffRefreshBtn" type="button">Refresh</button>
    </div>
    <div class="small">Add/edit staff in the pool. Deactivate hides them from dropdowns without deleting history.</div>

    <div class="row" style="margin-top:.9rem; gap:.6rem; flex-wrap:wrap; align-items:flex-end">
      <div class="field" style="min-width:320px; flex:1">
        <label>New staff display name</label>
        <input id="staffNewName" placeholder="e.g. Alex Smith"/>
      </div>
      <button class="btn" id="staffAddBtn" type="button">Add staff</button>

      <div class="field" style="min-width:260px; flex:1">
        <label>Search</label>
        <input id="staffSearch" placeholder="Filter staff..."/>
      </div>
      <label class="row" style="gap:.5rem; margin-left:auto">
        <input id="staffShowInactive" type="checkbox" style="width:18px;height:18px"/>
        <span class="mini muted">Show inactive</span>
      </label>
    </div>

    <div class="hr"></div>

    <div class="tableWrap">
      <table id="staffTbl">
        <thead>
          <tr>
            <th style="width:220px">Name</th>
            <th style="width:120px">Status</th>
            <th>Id</th>
            <th style="width:220px">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="small" style="margin-top:.75rem">
      Note: if you haven’t run the <span class="pill off">active</span> column patch yet, deactivate/reactivate will be disabled.
    </div>
  </section>
</div>

<!-- === Catalog Manager === -->
<div id="viewCatalog" class="hide">
  <section class="card">
    <div class="row space">
      <h2 style="margin:.1rem 0 .6rem 0">Catalog Manager</h2>
      <button class="btn ghost" id="catRefreshBtn" type="button">Refresh</button>
    </div>
    <div class="small">Maintain the master compliance portfolio (including converting <span class="pill off">TBC</span> into real cycle rules).</div>

    <div class="row" style="margin-top:.9rem; gap:.6rem; flex-wrap:wrap; align-items:flex-end">
      <div class="field" style="min-width:320px; flex:1">
        <label>New item title</label>
        <input id="catNewTitle" placeholder="e.g. Asbestos Awareness"/>
      </div>
      <div class="field" style="min-width:220px">
        <label>Category</label>
        <input id="catNewCategory" placeholder="e.g. Safety"/>
      </div>
      <div class="field" style="min-width:160px">
        <label>Cycle mode</label>
        <select id="catNewMode">
          <option value="fixed">fixed</option>
          <option value="one_time">one_time</option>
          <option value="manual">manual</option>
          <option value="tbc">tbc</option>
        </select>
      </div>
      <div class="field" style="min-width:120px">
        <label>Value</label>
        <input id="catNewVal" type="number" min="1" placeholder="e.g. 3"/>
      </div>
      <div class="field" style="min-width:140px">
        <label>Unit</label>
        <select id="catNewUnit">
          <option value="">(none)</option>
          <option value="days">days</option>
          <option value="months">months</option>
          <option value="years">years</option>
        </select>
      </div>
      <div class="field" style="min-width:160px">
        <label>Default horizon (days)</label>
        <input id="catNewHz" type="number" min="1" placeholder="60"/>
      </div>
      <button class="btn" id="catAddBtn" type="button">Add item</button>
    </div>

    <div class="row" style="margin-top:.8rem; gap:.6rem; flex-wrap:wrap">
      <div class="field" style="min-width:260px; flex:1">
        <label>Search</label>
        <input id="catSearch" placeholder="Filter catalog..."/>
      </div>
      <label class="row" style="gap:.5rem; margin-left:auto">
        <input id="catShowInactive" type="checkbox" style="width:18px;height:18px"/>
        <span class="mini muted">Show inactive</span>
      </label>
    </div>

    <div class="hr"></div>

    <div class="tableWrap">
      <table id="catTbl">
        <thead>
          <tr>
            <th style="width:320px">Title</th>
            <th style="width:160px">Category</th>
            <th style="width:120px">Mode</th>
            <th style="width:100px">Value</th>
            <th style="width:120px">Unit</th>
            <th style="width:140px">Horizon</th>
            <th style="width:120px">Active</th>
            <th style="width:220px">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="small" style="margin-top:.75rem">
      Tip: set <b>mode=fixed</b> with value+unit for standard cycles. Use <b>manual</b> when expiry varies per person. Use <b>one_time</b> when it should only trigger if never completed.
    </div>
  </section>
</div>
</main>

<script>

/** === Supabase config ===
 * Paste your project URL + anon key here (single source of truth).
 */
const SUPABASE_URL  = "https://ungtmfwxqawkdiflmora.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuZ3RtZnd4cWF3a2RpZmxtb3JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDY4NjQsImV4cCI6MjA3NzY4Mjg2NH0.Yaq0XfbbkwxJDUoiPCS7bLVBy70Wa-NOOWIxkpRRxdc";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
  auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
});

function setConn(ok, msg=""){
  const dot = document.querySelector("#whoAmI .dot");
  const st  = document.querySelector("#whoAmI .statusText");
  if(dot) dot.className = "dot " + (ok ? "green" : "grey");
  if(st) st.textContent = ok ? ("Connected" + (msg?(" · "+msg):"")) : ("Not connected" + (msg?(" · "+msg):""));
}

async function pingConn(){
  try{
    // Tiny call purely to verify REST connectivity (no auth/session storage needed).
    const res = await sb.schema("cck").from("staff_pool").select("id").limit(1);
    if(res.error) throw res.error;
    setConn(true);
  }catch(e){
    console.error(e);
    setConn(false, e.message || "ping failed");
  }
}


function $(q,root=document){ return root.querySelector(q); }
function $all(q,root=document){ return Array.from(root.querySelectorAll(q)); }

function toast(msg, kind="") {
  const el = document.createElement("div");
  el.className = "toast " + (kind||"");
  el.textContent = msg;
  document.body.appendChild(el);
  requestAnimationFrame(()=>el.classList.add("show"));
  setTimeout(()=>{ el.classList.remove("show"); setTimeout(()=>el.remove(), 250); }, 2400);
}

function isoDate(d) {
  if(!d) return null;
  const dt = (d instanceof Date) ? d : new Date(d);
  if(Number.isNaN(dt.getTime())) return null;
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const dd = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}

function addInterval(dateStr, val, unit) {
  if(!dateStr || !val || !unit) return null;
  const dt = new Date(dateStr + "T00:00:00Z");
  if(Number.isNaN(dt.getTime())) return null;
  if(unit==="days") dt.setUTCDate(dt.getUTCDate() + Number(val));
  if(unit==="months") dt.setUTCMonth(dt.getUTCMonth() + Number(val));
  if(unit==="years") dt.setUTCFullYear(dt.getUTCFullYear() + Number(val));
  return isoDate(dt);
}

function esc(s){ return String(s??"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }

// ===== Tabs =====
function setTab(tab){
  $("#tabPortfolios").classList.toggle("active", tab==="portfolios");
  $("#tabStaff").classList.toggle("active", tab==="staff");
  $("#tabCatalog").classList.toggle("active", tab==="catalog");

  $("#viewPortfolios").classList.toggle("hide", tab!=="portfolios");
  $("#viewStaff").classList.toggle("hide", tab!=="staff");
  $("#viewCatalog").classList.toggle("hide", tab!=="catalog");
}

function bindTabs(){
  $("#tabPortfolios").addEventListener("click", ()=>setTab("portfolios"));
  $("#tabStaff").addEventListener("click", async ()=>{ setTab("staff"); await refreshStaff(true); });
  $("#tabCatalog").addEventListener("click", async ()=>{ setTab("catalog"); await refreshCatalog(true); });
}

// ===== Shared caches =====
let STAFF=[], TEAMS=[], CATALOG=[];

// ===== Portfolios (existing behaviour) =====
let currentStaffId = null;
let assignMap = new Map(); // catalog_id -> audit row

function opt(el, value, label){
  const o=document.createElement("option");
  o.value=value; o.textContent=label;
  el.appendChild(o);
}

async function loadStaffActive() {
  // Prefer active=true if column exists; fall back if not.
  let res = await sb.schema("cck").from("staff_pool").select("id,display_name,active").order("display_name");
  if(res.error && /column .*active/i.test(res.error.message||"")){
    res = await sb.schema("cck").from("staff_pool").select("id,display_name").order("display_name");
  }
  if(res.error) throw res.error;
  const rows = res.data || [];
  if(rows.length && "active" in rows[0]) return rows.filter(r=>r.active!==false);
  return rows;
}

async function loadTeams() {
  const { data, error } = await sb.schema("cck").from("teams").select("id,name").order("name");
  if(error) throw error;
  return data || [];
}

async function loadCatalogActive() {
  const { data, error } = await sb.schema("cck").from("compliance_catalog")
    .select("id,title,cycle_mode,cycle_value,cycle_unit,default_horizon_days,active,category")
    .eq("active", true)
    .order("title");
  if(error) throw error;
  return data || [];
}

async function ensurePersonSettings(staff_id) {
  const { data, error } = await sb.schema("cck").from("compliance_person_settings")
    .select("staff_id,automation_enabled,default_owner_staff_id,default_owner_team_id,default_horizon_days")
    .eq("staff_id", staff_id)
    .maybeSingle();
  if(error) throw error;
  if(data) return data;

  const ins = await sb.schema("cck").from("compliance_person_settings")
    .insert({ staff_id, automation_enabled:false });
  if(ins.error) throw ins.error;

  const again = await sb.schema("cck").from("compliance_person_settings")
    .select("staff_id,automation_enabled,default_owner_staff_id,default_owner_team_id,default_horizon_days")
    .eq("staff_id", staff_id)
    .maybeSingle();
  if(again.error) throw again.error;
  return again.data;
}

async function loadAssignments(staff_id) {
  const { data, error } = await sb.schema("cck").from("v_compliance_audit")
    .select("catalog_id,compliance_title,cycle_mode,cycle_value,cycle_unit,horizon_days,manual_next_expiry_at,last_completed_at,next_expiry_at,automation_enabled")
    .eq("staff_id", staff_id)
    .order("compliance_title");
  if(error) throw error;
  return data || [];
}

async function upsertAssignment(staff_id, catalog_id, active=true) {
  const { data: existing, error: selErr } = await sb.schema("cck").from("compliance_assignments")
    .select("id,active").eq("staff_id", staff_id).eq("catalog_id", catalog_id).maybeSingle();
  if(selErr) throw selErr;
  if(!existing) {
    const ins = await sb.schema("cck").from("compliance_assignments").insert({ staff_id, catalog_id, active });
    if(ins.error) throw ins.error;
  } else {
    const upd = await sb.schema("cck").from("compliance_assignments").update({ active }).eq("id", existing.id);
    if(upd.error) throw upd.error;
  }
}

async function deleteAssignment(staff_id, catalog_id) {
  const upd = await sb.schema("cck").from("compliance_assignments").update({ active:false })
    .eq("staff_id", staff_id).eq("catalog_id", catalog_id);
  if(upd.error) throw upd.error;
}

async function upsertRecord(staff_id, catalog_id, last_completed_at=null, next_expiry_at=null, last_task_id=null) {
  const payload = { staff_id, catalog_id, last_completed_at, next_expiry_at, last_task_id };
  const res = await sb.schema("cck").from("compliance_records").upsert(payload, { onConflict:"staff_id,catalog_id" });
  if(res.error) throw res.error;
}

async function setManualExpiry(staff_id, catalog_id, manual_next_expiry_at=null) {
  const res = await sb.schema("cck").from("compliance_assignments")
    .update({ manual_next_expiry_at })
    .eq("staff_id", staff_id).eq("catalog_id", catalog_id);
  if(res.error) throw res.error;
}

async function setOverrides(staff_id, catalog_id, horizon_override_days=null, cycle_override_value=null, cycle_override_unit=null) {
  const res = await sb.schema("cck").from("compliance_assignments")
    .update({ horizon_override_days, cycle_override_value, cycle_override_unit })
    .eq("staff_id", staff_id).eq("catalog_id", catalog_id);
  if(res.error) throw res.error;
}

async function updatePersonSettings(staff_id, patch) {
  const res = await sb.schema("cck").from("compliance_person_settings").update(patch).eq("staff_id", staff_id);
  if(res.error) throw res.error;
}

function statusPill(row) {
  const mode = row.cycle_mode;
  if(mode==="tbc") return `<span class="pill off">TBC</span>`;
  if(mode==="manual" && !row.manual_next_expiry_at && !row.next_expiry_at) return `<span class="pill off">Manual</span>`;
  if(mode==="one_time") {
    return row.last_completed_at ? `<span class="pill ok">Done</span>` : `<span class="pill warn">Not done</span>`;
  }
  const exp = row.manual_next_expiry_at || row.next_expiry_at;
  if(!exp) return `<span class="pill off">No date</span>`;
  const expDt = new Date(exp + "T00:00:00Z");
  const now = new Date();
  const horizonDays = Number(row.horizon_days || 60);
  const horizonStart = new Date(expDt.getTime());
  horizonStart.setUTCDate(horizonStart.getUTCDate() - horizonDays);

  if(now > expDt) return `<span class="pill bad">Overdue</span>`;
  if(now >= horizonStart) return `<span class="pill warn">Due soon</span>`;
  return `<span class="pill ok">OK</span>`;
}

async function bootPortfolios(){
  STAFF = await loadStaffActive();
  TEAMS = await loadTeams();
  CATALOG = await loadCatalogActive();

  const personSel = $("#personSel");
  personSel.innerHTML="";
  opt(personSel,"","Select person...");
  STAFF.forEach(s=>opt(personSel, s.id, s.display_name));

  const ownerSel = $("#ownerSel");
  ownerSel.innerHTML="";
  opt(ownerSel,"","(None)");
  STAFF.forEach(s=>opt(ownerSel, s.id, s.display_name));

  const ownerTeamSel = $("#ownerTeamSel");
  ownerTeamSel.innerHTML="";
  opt(ownerTeamSel,"","(None)");
  TEAMS.forEach(t=>opt(ownerTeamSel, t.id, t.name));

  personSel.addEventListener("change", async ()=>{
    currentStaffId = personSel.value || null;
    await loadPersonState();
  });

  $("#refreshBtn").addEventListener("click", async ()=>{ await loadPersonState(true); });
  $("#filterInp").addEventListener("input", ()=>renderItems());

  $("#saveSettingsBtn").addEventListener("click", async ()=>{
    if(!currentStaffId){ toast("Pick a person first","bad"); return; }
    const patch = {
      automation_enabled: $("#autoToggle").checked,
      default_owner_staff_id: $("#ownerSel").value || null,
      default_owner_team_id: $("#ownerTeamSel").value || null,
      default_horizon_days: $("#horizonInp").value ? Number($("#horizonInp").value) : null
    };
    await updatePersonSettings(currentStaffId, patch);
    toast("Settings saved","ok");
  });

  $("#autoToggle").addEventListener("change", ()=>{
    const on = $("#autoToggle").checked;
    $("#autoLabel").textContent = on ? "ON" : "OFF";
    $("#autoLabel").className = "pill " + (on ? "ok" : "off");
  });
}

async function loadPersonState(){
  if(!currentStaffId){
    $("#itemsTbl tbody").innerHTML = `<tr><td colspan="8" class="muted">Select a person.</td></tr>`;
    return;
  }
  const ps = await ensurePersonSettings(currentStaffId);

  $("#autoToggle").checked = !!ps.automation_enabled;
  $("#autoLabel").textContent = ps.automation_enabled ? "ON" : "OFF";
  $("#autoLabel").className = "pill " + (ps.automation_enabled ? "ok" : "off");

  $("#ownerSel").value = ps.default_owner_staff_id || "";
  $("#ownerTeamSel").value = ps.default_owner_team_id || "";
  $("#horizonInp").value = (ps.default_horizon_days ?? "");

  const rows = await loadAssignments(currentStaffId);
  assignMap = new Map(rows.map(r=>[r.catalog_id, r]));

  renderItems();
}

function renderItems(){
  const tb = $("#itemsTbl tbody");
  const q = ($("#filterInp").value||"").trim().toLowerCase();

  const rows = CATALOG
    .filter(c=>!q || c.title.toLowerCase().includes(q))
    .map(c=>{
      const a = assignMap.get(c.id) || null;
      const checked = !!a;
      const mode = a ? a.cycle_mode : c.cycle_mode;
      const last = a?.last_completed_at || "";
      const exp = a?.manual_next_expiry_at || a?.next_expiry_at || "";
      const horizon = a?.horizon_days ?? c.default_horizon_days ?? 60;

      const statusRow = a ? a : {
        cycle_mode: c.cycle_mode,
        horizon_days: horizon,
        last_completed_at: null,
        next_expiry_at: null,
        manual_next_expiry_at: null
      };

      return `
        <tr data-cid="${c.id}">
          <td><input type="checkbox" class="useChk" ${checked?"checked":""}/></td>
          <td>
            <div style="font-weight:700">${esc(c.title)}</div>
            <div class="small">${esc(c.category||"")}</div>
          </td>
          <td><span class="pill">${esc(mode)}</span></td>
          <td>
            <input type="date" class="input lastInp" value="${last||""}" ${checked?"":"disabled"} />
          </td>
          <td>
            <input type="date" class="input expInp" value="${exp||""}" ${checked?"":"disabled"} />
            <div class="small">Manual uses this. Fixed auto-computes.</div>
          </td>
          <td>
            <input type="number" class="input hzInp" min="1" value="${horizon}" ${checked?"":"disabled"} />
          </td>
          <td>${statusPill(statusRow)}</td>
          <td>
            <div class="row" style="gap:.4rem;flex-wrap:wrap">
              <input type="number" class="input ovVal" min="1" placeholder="cycle" style="width:84px" ${checked?"":"disabled"} />
              <select class="input ovUnit" style="width:110px" ${checked?"":"disabled"}>
                <option value="">unit</option>
                <option value="days">days</option>
                <option value="months">months</option>
                <option value="years">years</option>
              </select>
              <button class="btn sm saveRowBtn" ${checked?"":"disabled"}>Save</button>
            </div>
            <div class="small">Overrides only needed for manual/edge cases.</div>
          </td>
        </tr>
      `;
    });

  tb.innerHTML = rows.join("") || `<tr><td colspan="8" class="muted">No items.</td></tr>`;
  bindPortfolioRowEvents();
}

function bindPortfolioRowEvents(){
  $all("#itemsTbl tbody tr").forEach(tr=>{
    const cid = tr.getAttribute("data-cid");

    const chk = tr.querySelector(".useChk");
    const lastInp = tr.querySelector(".lastInp");
    const expInp  = tr.querySelector(".expInp");
    const hzInp   = tr.querySelector(".hzInp");
    const saveBtn = tr.querySelector(".saveRowBtn");
    const ovVal   = tr.querySelector(".ovVal");
    const ovUnit  = tr.querySelector(".ovUnit");

    chk.addEventListener("change", async ()=>{
      try{
        if(!currentStaffId) return;
        if(chk.checked){
          await upsertAssignment(currentStaffId, cid, true);
          const rows = await loadAssignments(currentStaffId);
          assignMap = new Map(rows.map(r=>[r.catalog_id, r]));
          toast("Assigned","ok");
        }else{
          await deleteAssignment(currentStaffId, cid);
          assignMap.delete(cid);
          toast("Unassigned","ok");
        }
        renderItems();
      }catch(e){
        console.error(e);
        toast(e.message || "Failed","bad");
        chk.checked = !chk.checked;
      }
    });

    lastInp.addEventListener("change", async ()=>{
      try{
        if(!currentStaffId || !chk.checked) return;

        const audit = assignMap.get(cid);
        const last = lastInp.value || null;

        let next = null;
        if(audit){
          if(audit.cycle_mode==="fixed"){
            next = last ? addInterval(last, audit.cycle_value, audit.cycle_unit) : null;
          }else{
            next = null;
          }
        }
        await upsertRecord(currentStaffId, cid, last, next, null);

        const rows = await loadAssignments(currentStaffId);
        assignMap = new Map(rows.map(r=>[r.catalog_id, r]));
        toast("Saved completion date","ok");
        renderItems();
      }catch(e){
        console.error(e);
        toast(e.message || "Failed to save date","bad");
      }
    });

    expInp.addEventListener("change", async ()=>{
      try{
        if(!currentStaffId || !chk.checked) return;
        const val = expInp.value || null;
        await setManualExpiry(currentStaffId, cid, val);

        const audit = assignMap.get(cid);
        if(audit && (audit.cycle_mode==="manual" || audit.cycle_mode==="tbc")){
          await upsertRecord(currentStaffId, cid, audit.last_completed_at || null, val, null);
        }
        const rows = await loadAssignments(currentStaffId);
        assignMap = new Map(rows.map(r=>[r.catalog_id, r]));
        toast("Saved expiry","ok");
        renderItems();
      }catch(e){
        console.error(e);
        toast(e.message || "Failed to save expiry","bad");
      }
    });

    hzInp.addEventListener("change", async ()=>{
      try{
        if(!currentStaffId || !chk.checked) return;
        const hz = hzInp.value ? Number(hzInp.value) : null;
        await setOverrides(currentStaffId, cid, hz, null, null);
        const rows = await loadAssignments(currentStaffId);
        assignMap = new Map(rows.map(r=>[r.catalog_id, r]));
        toast("Saved horizon override","ok");
        renderItems();
      }catch(e){
        console.error(e);
        toast(e.message || "Failed to save horizon","bad");
      }
    });

    saveBtn.addEventListener("click", async ()=>{
      try{
        if(!currentStaffId || !chk.checked) return;
        const v = ovVal.value ? Number(ovVal.value) : null;
        const u = ovUnit.value || null;
        await setOverrides(currentStaffId, cid, (hzInp.value?Number(hzInp.value):null), v, u);

        const audit = assignMap.get(cid);
        const last = tr.querySelector(".lastInp").value || null;
        if(last && v && u){
          const next = addInterval(last, v, u);
          await upsertRecord(currentStaffId, cid, last, next, null);
        }
        const rows = await loadAssignments(currentStaffId);
        assignMap = new Map(rows.map(r=>[r.catalog_id, r]));
        toast("Overrides saved","ok");
        renderItems();
      }catch(e){
        console.error(e);
        toast(e.message || "Failed to save overrides","bad");
      }
    });
  });
}

// ===== Staff Manager =====
let STAFF_ALL = [];
let STAFF_HAS_ACTIVE = true;

async function loadStaffAll(){
  let res = await sb.schema("cck").from("staff_pool").select("id,display_name,active").order("display_name");
  if(res.error && /column .*active/i.test(res.error.message||"")){
    STAFF_HAS_ACTIVE = false;
    res = await sb.schema("cck").from("staff_pool").select("id,display_name").order("display_name");
  }
  if(res.error) throw res.error;
  return res.data || [];
}

function renderStaff(){
  const tb = $("#staffTbl tbody");
  const q = ($("#staffSearch").value||"").trim().toLowerCase();
  const showInactive = $("#staffShowInactive").checked;

  const rows = (STAFF_ALL||[])
    .filter(s=>{
      const active = ("active" in s) ? (s.active!==false) : true;
      if(!showInactive && !active) return false;
      if(q && !(s.display_name||"").toLowerCase().includes(q)) return false;
      return true;
    });

  tb.innerHTML = rows.map(s=>{
    const active = ("active" in s) ? (s.active!==false) : true;
    const pill = active ? `<span class="pill ok">Active</span>` : `<span class="pill off">Inactive</span>`;
    const disableToggle = STAFF_HAS_ACTIVE ? "" : "disabled title=\"Run the staff_pool.active SQL patch to enable deactivation\"";

    return `
      <tr data-id="${s.id}">
        <td><input class="input staffNameInp" value="${esc(s.display_name||"")}" /></td>
        <td>${pill}</td>
        <td class="small">${esc(s.id)}</td>
        <td>
          <div class="row" style="gap:.4rem;flex-wrap:wrap">
            <button class="btn sm staffSaveBtn">Save</button>
            <button class="btn sm ghost staffToggleBtn" ${disableToggle}>${active ? "Deactivate" : "Reactivate"}</button>
          </div>
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="4" class="muted">No staff found.</td></tr>`;

  bindStaffRowEvents();
}

function bindStaffRowEvents(){
  $all("#staffTbl tbody tr").forEach(tr=>{
    const id = tr.getAttribute("data-id");
    const nameInp = tr.querySelector(".staffNameInp");
    const saveBtn = tr.querySelector(".staffSaveBtn");
    const togBtn  = tr.querySelector(".staffToggleBtn");

    saveBtn.addEventListener("click", async ()=>{
      try{
        const name = (nameInp.value||"").trim();
        if(!name) return toast("Name required","bad");
        const res = await sb.schema("cck").from("staff_pool").update({ display_name: name }).eq("id", id);
        if(res.error) throw res.error;
        toast("Saved","ok");
        await refreshStaff(false);
        await refreshPortfolioReference();
      }catch(e){
        console.error(e);
        toast(e.message||"Save failed","bad");
      }
    });

    if(togBtn){
      togBtn.addEventListener("click", async ()=>{
        if(!STAFF_HAS_ACTIVE) return;
        try{
          const row = STAFF_ALL.find(x=>x.id===id);
          const active = ("active" in row) ? (row.active!==false) : true;
          const res = await sb.schema("cck").from("staff_pool").update({ active: !active }).eq("id", id);
          if(res.error) throw res.error;
          toast(active ? "Deactivated" : "Reactivated","ok");
          await refreshStaff(false);
          await refreshPortfolioReference();
        }catch(e){
          console.error(e);
          toast(e.message||"Toggle failed","bad");
        }
      });
    }
  });
}

async function refreshStaff(showToast){
  try{
    STAFF_ALL = await loadStaffAll();
    renderStaff();
    if(showToast) toast("Staff refreshed","ok");
  }catch(e){
    console.error(e);
    toast(e.message||"Failed to load staff","bad");
  }
}

async function addStaff(){
  const name = ($("#staffNewName").value||"").trim();
  if(!name) return toast("Enter a name","bad");
  try{
    let payload = { display_name: name };
    if(STAFF_HAS_ACTIVE) payload.active = true;
    const res = await sb.schema("cck").from("staff_pool").insert(payload);
    if(res.error) throw res.error;
    $("#staffNewName").value="";
    toast("Staff added","ok");
    await refreshStaff(false);
    await refreshPortfolioReference();
  }catch(e){
    console.error(e);
    toast(e.message||"Add staff failed","bad");
  }
}

// ===== Catalog Manager =====
let CAT_ALL = [];

async function loadCatalogAll(){
  const res = await sb.schema("cck").from("compliance_catalog")
    .select("id,title,category,cycle_mode,cycle_value,cycle_unit,default_horizon_days,active")
    .order("title");
  if(res.error) throw res.error;
  return res.data || [];
}

function renderCatalog(){
  const tb = $("#catTbl tbody");
  const q = ($("#catSearch").value||"").trim().toLowerCase();
  const showInactive = $("#catShowInactive").checked;

  const rows = (CAT_ALL||[])
    .filter(r=>{
      const active = r.active!==false;
      if(!showInactive && !active) return false;
      if(q && !(r.title||"").toLowerCase().includes(q) && !(r.category||"").toLowerCase().includes(q)) return false;
      return true;
    });

  tb.innerHTML = rows.map(r=>{
    const active = r.active!==false;
    return `
      <tr data-id="${r.id}">
        <td><input class="input catTitle" value="${esc(r.title||"")}" /></td>
        <td><input class="input catCategory" value="${esc(r.category||"")}" /></td>
        <td>
          <select class="input catMode">
            ${["fixed","one_time","manual","tbc"].map(m=>`<option value="${m}" ${r.cycle_mode===m?"selected":""}>${m}</option>`).join("")}
          </select>
        </td>
        <td><input class="input catVal" type="number" min="1" value="${r.cycle_value??""}" placeholder=""/></td>
        <td>
          <select class="input catUnit">
            <option value="" ${!r.cycle_unit?"selected":""}>(none)</option>
            ${["days","months","years"].map(u=>`<option value="${u}" ${r.cycle_unit===u?"selected":""}>${u}</option>`).join("")}
          </select>
        </td>
        <td><input class="input catHz" type="number" min="1" value="${r.default_horizon_days??""}" placeholder="60"/></td>
        <td>${active ? `<span class="pill ok">Yes</span>` : `<span class="pill off">No</span>`}</td>
        <td>
          <div class="row" style="gap:.4rem;flex-wrap:wrap">
            <button class="btn sm catSaveBtn">Save</button>
            <button class="btn sm ghost catToggleBtn">${active ? "Deactivate" : "Activate"}</button>
          </div>
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="8" class="muted">No catalog items.</td></tr>`;

  bindCatalogRowEvents();
}

function bindCatalogRowEvents(){
  $all("#catTbl tbody tr").forEach(tr=>{
    const id = tr.getAttribute("data-id");
    const title = tr.querySelector(".catTitle");
    const cat = tr.querySelector(".catCategory");
    const mode = tr.querySelector(".catMode");
    const val = tr.querySelector(".catVal");
    const unit = tr.querySelector(".catUnit");
    const hz = tr.querySelector(".catHz");
    const save = tr.querySelector(".catSaveBtn");
    const toggle = tr.querySelector(".catToggleBtn");

    save.addEventListener("click", async ()=>{
      try{
        const payload = {
          title: (title.value||"").trim(),
          category: (cat.value||"").trim() || null,
          cycle_mode: mode.value,
          cycle_value: val.value ? Number(val.value) : null,
          cycle_unit: unit.value || null,
          default_horizon_days: hz.value ? Number(hz.value) : null
        };
        if(!payload.title) return toast("Title required","bad");

        // basic sanity: fixed needs value+unit
        if(payload.cycle_mode==="fixed" && (!payload.cycle_value || !payload.cycle_unit)){
          return toast("Fixed needs value + unit","bad");
        }
        if(payload.cycle_mode!=="fixed"){
          // keep DB tidy
          payload.cycle_value = null;
          payload.cycle_unit = null;
        }

        const res = await sb.schema("cck").from("compliance_catalog").update(payload).eq("id", id);
        if(res.error) throw res.error;
        toast("Saved","ok");
        await refreshCatalog(false);
        await refreshPortfolioReference();
      }catch(e){
        console.error(e);
        toast(e.message||"Save failed","bad");
      }
    });

    toggle.addEventListener("click", async ()=>{
      try{
        const row = CAT_ALL.find(x=>x.id===id);
        const active = row.active!==false;
        const res = await sb.schema("cck").from("compliance_catalog").update({ active: !active }).eq("id", id);
        if(res.error) throw res.error;
        toast(active ? "Deactivated" : "Activated","ok");
        await refreshCatalog(false);
        await refreshPortfolioReference();
      }catch(e){
        console.error(e);
        toast(e.message||"Toggle failed","bad");
      }
    });
  });
}

async function refreshCatalog(showToast){
  try{
    CAT_ALL = await loadCatalogAll();
    renderCatalog();
    if(showToast) toast("Catalog refreshed","ok");
  }catch(e){
    console.error(e);
    toast(e.message||"Failed to load catalog","bad");
  }
}

async function addCatalogItem(){
  const title = ($("#catNewTitle").value||"").trim();
  if(!title) return toast("Title required","bad");
  const category = ($("#catNewCategory").value||"").trim() || null;
  const mode = $("#catNewMode").value;
  const val = $("#catNewVal").value ? Number($("#catNewVal").value) : null;
  const unit = $("#catNewUnit").value || null;
  const hz = $("#catNewHz").value ? Number($("#catNewHz").value) : null;

  if(mode==="fixed" && (!val || !unit)) return toast("Fixed needs value + unit","bad");

  const payload = {
    title,
    category,
    cycle_mode: mode,
    cycle_value: (mode==="fixed" ? val : null),
    cycle_unit: (mode==="fixed" ? unit : null),
    default_horizon_days: hz,
    active: true
  };

  try{
    const res = await sb.schema("cck").from("compliance_catalog").insert(payload);
    if(res.error) throw res.error;

    $("#catNewTitle").value="";
    $("#catNewCategory").value="";
    $("#catNewVal").value="";
    $("#catNewUnit").value="";
    $("#catNewHz").value="";

    toast("Catalog item added","ok");
    await refreshCatalog(false);
    await refreshPortfolioReference();
  }catch(e){
    console.error(e);
    toast(e.message||"Add item failed","bad");
  }
}

// ===== Cross-refresh helpers =====
async function refreshPortfolioReference(){
  // Keep dropdowns in Portfolios current after staff/catalog edits.
  const prevStaff = currentStaffId;
  STAFF = await loadStaffActive();
  CATALOG = await loadCatalogActive();

  // Update person / owner dropdowns without nuking event handlers
  const personSel = $("#personSel");
  const ownerSel = $("#ownerSel");

  if(personSel && ownerSel){
    const prevPerson = personSel.value;
    personSel.innerHTML=""; opt(personSel,"","Select person..."); STAFF.forEach(s=>opt(personSel, s.id, s.display_name));
    ownerSel.innerHTML=""; opt(ownerSel,"","(None)"); STAFF.forEach(s=>opt(ownerSel, s.id, s.display_name));
    // restore selection if still present
    if(prevPerson && STAFF.some(s=>s.id===prevPerson)) personSel.value = prevPerson;
    if(prevStaff && STAFF.some(s=>s.id===prevStaff)) currentStaffId = prevStaff;
  }

  // Re-render table if person loaded
  if(currentStaffId){
    const rows = await loadAssignments(currentStaffId);
    assignMap = new Map(rows.map(r=>[r.catalog_id, r]));
    renderItems();
  }
}

// ===== Boot =====
(async function boot(){
  try{
    bindTabs();
    setTab("portfolios");

    await bootPortfolios();

    // Staff/Catalog binds
    $("#staffRefreshBtn").addEventListener("click", ()=>refreshStaff(true));
    $("#staffAddBtn").addEventListener("click", addStaff);
    $("#staffSearch").addEventListener("input", renderStaff);
    $("#staffShowInactive").addEventListener("change", renderStaff);

    $("#catRefreshBtn").addEventListener("click", ()=>refreshCatalog(true));
    $("#catAddBtn").addEventListener("click", addCatalogItem);
    $("#catSearch").addEventListener("input", renderCatalog);
    $("#catShowInactive").addEventListener("change", renderCatalog);
    $("#catNewMode").addEventListener("change", ()=>{
      const m = $("#catNewMode").value;
      const needFixed = (m==="fixed");
      $("#catNewVal").disabled = !needFixed;
      $("#catNewUnit").disabled = !needFixed;
    });
    $("#catNewMode").dispatchEvent(new Event("change"));

    // Prime but don't force load heavy tabs
    STAFF_ALL = await loadStaffAll();
    CAT_ALL = await loadCatalogAll();
  }catch(e){
    console.error(e);
    toast(e.message || "Failed to boot admin","bad");
  }
})();

</script>
</body>
</html>
